---
# Standard gitlab ci configuration file.
stages:
  - check
  - build
  - publish

check signature of tag:
  image: registry.merchise.org/merchise/python-dev:3.6-alpine
  stage: check
  script:
    - cat $GNUPG_KEY_FILE | gpg --import
    - git verify-tag $CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /^\d+(\.\d+)*(|a\d+|b\d+|rc\d+)?(\.post\d+|\.dev\d+)?$/


build source distribution:
  image: registry.merchise.org/merchise/python-dev:3.6-alpine
  stage: build
  script:
    - python setup.py sdist
  artifacts:
    paths:
      - dist/
  only:
    - master
    - tags

build binary distribution:
  image: registry.merchise.org/merchise/python-dev:3.6-alpine
  stage: build
  script:
    - python setup.py bdist_wheel
  artifacts:
    paths:
      - dist/
  only:
    - master
    - tags


publish_locally:
  variables:
    GIT_STRATEGY: none
  stage: publish
  script:
    - ssh-keyscan -H gestion.lahavane.com >> ~/.ssh/known_hosts
    - ssh manu@gestion.lahavane.com "mkdir -p Repos/merchise.lint"
    - scp dist/* manu@gestion.lahavane.com:Repos/merchise.lint/
  tags:
    - repo.lahavane.com
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /^\d+(\.\d+)*(|a\d+|b\d+|rc\d+)?(\.post\d+)?$/
  dependencies:
    - check signature of tag
    - build source distribution
    - build binary distribution
  environment:
    name: repo.lahavane.com
    url: http://repo.lahavane.com/pypi/$CI_PROJECT_NAME


publish in pypi:
  image: registry.merchise.org/merchise/python-dev:3.6-alpine
  variables:
    GIT_STRATEGY: none
  stage: publish
  script:
    - twine upload --skip-existing -u "$PYPI_USERNAME" -p "$PYPI_PASSWORD" dist/*
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /^\d+(\.\d+)*(|a\d+|b\d+|rc\d+)?(\.post\d+)?$/
  dependencies:
    - check signature of tag
    - build source distribution
    - build binary distribution
  environment:
    name: pypi
    url: https://pypi.org/project/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME
