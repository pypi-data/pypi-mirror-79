function W(e,n){if(e==null)return{};var t=k(e,n),s,r;if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++){if(s=a[r],n.indexOf(s)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(e,s))continue;t[s]=e[s]}}return t}function k(e,n){if(e==null)return{};var t={},s=Object.keys(e),r,a;for(a=0;a<s.length;a++){if(r=s[a],n.indexOf(r)>=0)continue;t[r]=e[r]}return t}function S(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);n&&(s=s.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,s)}return t}function u(e){for(var n=1;n<arguments.length;n++){var t=arguments[n]!=null?arguments[n]:{};n%2?S(Object(t),!0).forEach(function(s){x(e,s,t[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):S(Object(t)).forEach(function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(t,s))})}return e}function x(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}import{color as P,colorAlt as I}from"../utils/chart.js";import{useCallback as C,useEffect as y,useMemo as g,useReducer as Q}from"../../web_modules/react.js";import{cache as F}from"../../web_modules/swr.js";import _ from"../../web_modules/lodash/camelCase.js";import K from"../../web_modules/lodash/groupBy.js";import L from"../../web_modules/lodash/intersection.js";import M from"../../web_modules/lodash/intersectionBy.js";import N from"../../web_modules/lodash/uniq.js";import z from"./useGlobalState.js";import H from"./useQuery.js";import{useRunningRequest as J}from"./useRequest.js";var i;(function(e){e[e.initRuns=0]="initRuns",e[e.setRuns=1]="setRuns",e[e.setSelectedRuns=2]="setSelectedRuns",e[e.initTags=3]="initTags",e[e.setTags=4]="setTags",e[e.setSelectedTags=5]="setSelectedTags"})(i||(i={}));const j=(e,n)=>Object.entries(K(e.filter(t=>!!e.find(s=>s.label===t.label)).reduce((t,s)=>(n&&n[s.label]&&Array.prototype.push.apply(t,n[s.label].map(r=>({label:r,run:s}))),t),[]),t=>t.label)).map(([t,s])=>({label:t,runs:s.map(r=>r.run)})),U=e=>e==null?void 0:e.map((n,t)=>{const s=t%P.length;return{label:n,colors:[P[s],I[s]]}}),V=(e,n)=>{switch(n.type){case i.initRuns:{const t=n.payload,s=t.length?L(t,e.globalRuns):e.globalRuns,r=s.length?s:t,a=U(t),d=a.filter(h=>r.includes(h.label)),m=j(d,e.initTags);return u(u({},e),{},{initRuns:t,globalRuns:r,runs:a,selectedRuns:d,tags:m,selectedTags:m})}case i.setRuns:{const t=n.payload,s=M(e.selectedRuns,t,a=>a.label),r=j(s,e.initTags);return u(u({},e),{},{runs:t,selectedRuns:s,tags:r,selectedTags:r})}case i.setSelectedRuns:{const t=n.payload,s=t.map(a=>a.label),r=j(t,e.initTags);return u(u({},e),{},{globalRuns:s,selectedRuns:t,tags:r,selectedTags:r})}case i.initTags:{const t=n.payload,s=j(e.selectedRuns,t);return u(u({},e),{},{initTags:t,tags:s,selectedTags:s})}case i.setTags:{const t=n.payload;return u(u({},e),{},{tags:t,selectedTags:t})}case i.setSelectedTags:{const t=n.payload;return u(u({},e),{},{selectedTags:t})}default:throw new Error}},X=(e,n)=>{const t=H(),{data:s,loading:r,error:a}=J(`/${e}/tags`,n);y(()=>()=>F.delete(`/${e}/tags`),[e]);const d=g(()=>_(e),[e]),[m,h]=z(),q=g(()=>{var l,o;return(l=(o=m[_(d)])===null||o===void 0?void 0:o.runs)!==null&&l!==void 0?l:[]},[d,m]),v=g(()=>{var l;return(l=s==null?void 0:s.runs)!==null&&l!==void 0?l:[]},[s]),p=g(()=>s?v.reduce((l,o,O)=>{if(l[o]){var f,b;l[o]=[...l[o],...(f=(b=s.tags)===null||b===void 0?void 0:b[O])!==null&&f!==void 0?f:[]]}else{var T;l[o]=(T=s.tags[O])!==null&&T!==void 0?T:[]}return l},{}):{},[v,s]),[c,R]=Q(V,{initRuns:[],globalRuns:q,runs:[],selectedRuns:[],initTags:{},tags:[],selectedTags:[]}),w=g(()=>t.runs?N(Array.isArray(t.runs)?t.runs:t.runs.split(",")):[],[t]),D=C(l=>R({type:i.setSelectedRuns,payload:l}),[]),E=C(l=>R({type:i.setSelectedTags,payload:l}),[]);y(()=>R({type:i.initRuns,payload:v||[]}),[v]),y(()=>R({type:i.initTags,payload:p||{}}),[p]),y(()=>{if(w.length){const l=c.runs.filter(o=>w.includes(o.label));R({type:i.setSelectedRuns,payload:l.length?l:c.runs})}},[w,c.runs]),y(()=>h({[d]:{runs:c.globalRuns}}),[d,c.globalRuns,h]);const B=g(()=>c.tags.reduce((l,o)=>{let{runs:O}=o,f=W(o,["runs"]);return Array.prototype.push.apply(l,O.map(b=>u(u({},f),{},{run:b,id:`${f.label}-${b.label}`}))),l},[]),[c.tags]),G=g(()=>c.selectedRuns.filter(l=>{var o;return!!(p==null||((o=p[l.label])===null||o===void 0)?void 0:o.length)}),[c.selectedRuns,p]);return u(u({},c),{},{tagsWithSingleRun:B,runsInTags:G,onChangeRuns:D,onChangeTags:E,loading:r,error:a})};export default X;
