import o,{useCallback as k,useEffect as y,useMemo as C,useRef as p,useState as x}from"../../../web_modules/react.js";import{ellipsis as I,em as _,primaryColor as M,rem as a,size as V,textLightColor as A,textLighterColor as B}from"../../utils/style.js";import D from"../ChartToolbox.js";import H from"../../../web_modules/react-spinners/GridLoader.js";import J from"./StepSlider.js";import{formatTime as K}from"../../utils/index.js";import z from"../../../web_modules/lodash/isEmpty.js";import N from"../../../web_modules/query-string.js";import f from"../../../web_modules/styled-components.js";import{useRunningRequest as Q}from"../../hooks/useRequest.js";import{useTranslation as X}from"../../../web_modules/react-i18next.js";const Y=f.div.withConfig({displayName:"SampleChart__Wrapper",componentId:"sc-19m7v01-0"})(["height:100%;padding:",";padding-bottom:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;> *{flex-grow:0;flex-shrink:0;}"],_(20)),Z=f.div.withConfig({displayName:"SampleChart__Title",componentId:"sc-19m7v01-1"})(["display:flex;justify-content:space-between;align-items:center;margin-bottom:",";> h4{font-size:",";font-weight:700;flex-shrink:1;flex-grow:1;padding:0;margin:0;","}> span{font-size:",";flex-shrink:0;flex-grow:0;color:",";"," max-width:50%;&::before{content:'';display:inline-block;"," margin-right:",";border-radius:",";vertical-align:middle;background-color:",";}}"],_(20),_(16),I(),_(14),A,I(),V(a(5),a(17)),a(8),a(2.5),r=>r.color),ee=f.div.withConfig({displayName:"SampleChart__Container",componentId:"sc-19m7v01-2"})(["flex-grow:1;flex-shrink:1;margin:"," 0;display:flex;justify-content:center;align-items:center;overflow:hidden;"],_(20)),te=f.div.withConfig({displayName:"SampleChart__Footer",componentId:"sc-19m7v01-3"})(["margin-bottom:",";display:flex;align-items:center;justify-content:space-between;"],a(18)),ne=f.div.withConfig({displayName:"SampleChart__FooterInfo",componentId:"sc-19m7v01-4"})(["color:",";font-size:",";> *{display:inline-block;margin-left:",";}"],B,a(12),a(10)),re=(r,l,v,c,g)=>`/${r}/${r}?${N.stringify({index:l,ts:g,run:v,tag:c})}`,oe=({run:r,tag:l,running:v,type:c,cache:g,footer:q,content:R})=>{const{t:m,i18n:F}=X(["sample","common"]),j=p(null),{data:t,error:S,loading:U}=Q(`/${c}/list?${N.stringify({run:r.label,tag:l})}`,!!v),w=C(()=>{var e;return(e=t==null?void 0:t.map(s=>s.step))!==null&&e!==void 0?e:[]},[t]),[n,L]=x(0),[E,$]=x(),i=p({}),d=p(null);y(()=>{Object.values(i.current).forEach(({timer:e})=>clearTimeout(e)),i.current={}},[l,r]);const u=C(()=>{var e;return(e=t==null?void 0:t[n].wallTime)!==null&&e!==void 0?e:0},[t,n]),h=k(()=>{if(!t)return;const e=re(c,n,r.label,l,u);i.current[n]={src:e,timer:setTimeout(()=>{(s=>delete i.current[s])(n)},g)},$(e),d.current=null},[c,n,r.label,l,u,t,g]),G=k(()=>{var e;(e=j.current)===null||e===void 0||e.save(`${r.label}-${l}-${w[n]}-${u.toString().replace(/\./,"_")}`)},[r.label,l,w,n,u]);y(()=>{if(i.current[n])$(i.current[n].src);else if(z(i.current))h();else return d.current=setTimeout(h,500),()=>{d.current!=null&&(clearTimeout(d.current),d.current=null)}},[n,h]);const[P,O]=x(!1),b=p(null),T=p(new IntersectionObserver(e=>{if(e[0].intersectionRatio>0){var s;O(!0),(s=T.current)===null||s===void 0||s.disconnect()}}));y(()=>{const e=T.current;if(b.current&&e)return e.observe(b.current),()=>e.disconnect()},[]);const W=C(()=>U||!i.current[n]||!P?o.createElement(H,{color:M,size:"10px"}):!t&&S?o.createElement("span",null,m("common:error")):z(t)?o.createElement("span",null,m("common:empty")):E?R(j,E):null,[P,U,S,t,n,E,m,R]);return o.createElement(Y,null,o.createElement(Z,{color:r.colors[0]},o.createElement("h4",null,l),o.createElement("span",null,r.label)),o.createElement(J,{value:n,steps:w,onChange:L,onChangeComplete:h},K(u,F.language)),o.createElement(ee,{ref:b},W),o.createElement(te,null,o.createElement(D,{items:[{icon:"download",tooltip:m(`sample:download-${c}`),onClick:G}]}),o.createElement(ne,null,o.createElement("span",null,m("sample:sample"),m("common:colon"),(t==null?void 0:t.length)?`${n+1}/${t.length}`:"--/--"),q)))};export default oe;
