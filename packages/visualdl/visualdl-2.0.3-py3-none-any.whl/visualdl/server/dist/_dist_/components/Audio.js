import o,{useCallback as n,useEffect as A,useImperativeHandle as ee,useMemo as re,useRef as z,useState as i}from"../../web_modules/react.js";import{primaryActiveColor as M,primaryBackgroundColor as te,primaryColor as R,primaryFocusedColor as N,rem as t,size as oe,textLightColor as ne,textLighterColor as le}from"../utils/style.js";import{AudioPlayer as ie}from"../utils/audio.js";import T from"./Icon.js";import ae from"../../web_modules/react-spinners/PuffLoader.js";import se from"./RangeSlider.js";import ue from"../../web_modules/react-rangeslider.js";import ce from"../../web_modules/react-spinners/SyncLoader.js";import de from"../../web_modules/@tippyjs/react.js";import{fetcher as me}from"../utils/fetch.js";import V from"../../web_modules/mime-types.js";import pe from"../../web_modules/moment.js";import{saveAs as _e}from"../../web_modules/file-saver.js";import $ from"../../web_modules/styled-components.js";import fe from"../hooks/useRequest.js";import{useTranslation as ge}from"../../web_modules/react-i18next.js";const ve=$.div.withConfig({displayName:"Audio__Container",componentId:"sc-6r7be3-0"})(["background-color:",";border-radius:",";display:flex;align-items:center;justify-content:space-between;padding:0 ",";> .control{font-size:",";line-height:1;margin:0 ",";color:",";cursor:pointer;&.volumn{font-size:",";}&.disabled{color:",";cursor:not-allowed;}&:hover{color:",";}&:active{color:",";}}> .slider{flex-grow:1;padding:0 ",";}> .time{color:",";font-size:",";margin:0 ",";}"],te,t(8),t(20),t(16),t(10),R,t(20),ne,N,M,t(10),le,t(12),t(5)),be=$(ue).withConfig({displayName:"Audio__VolumnSlider",componentId:"sc-6r7be3-1"})(["margin:"," ",";width:",";height:",";cursor:pointer;position:relative;background-color:#dbdeeb;outline:none;border-radius:",";user-select:none;--color:",";&:hover{--color:",";}&:active{--color:",";}.rangeslider__fill{background-color:var(--color);position:absolute;bottom:0;width:100%;border-bottom-left-radius:",";border-bottom-right-radius:",";border-top:"," solid var(--color);box-sizing:content-box;}.rangeslider__handle{background-color:var(--color);"," position:absolute;left:-",";border-radius:50%;outline:none;.rangeslider__handle-tooltip,.rangeslider__handle-label{display:none;}}.rangeslider__labels{display:none;}"],t(15),t(18),t(4),t(100),t(2),R,N,M,t(2),t(2),t(4),oe(t(8),t(8)),t(2)),w=100;function D(c){const a=pe.duration(c,"seconds");return String(Math.floor(a.asMinutes())).padStart(2,"0")+":"+String(a.seconds()).padStart(2,"0")}const ye=o.forwardRef(({audioContext:c,src:a,cache:g,onLoading:d,onLoad:m,className:q},B)=>{const{t:O}=ge("common"),{data:l,error:F,loading:H}=fe(a??null,me,{dedupingInterval:g??2e3});ee(B,()=>({save:e=>{if(l){const f=l.type?V.extension(l.type):null;_e(l.data,e.replace(/[/\\?%*:|"<>]/g,"_")+(f?`.${f}`:""))}}}));const p=z(null),r=z(null),[L,v]=i(0),[_,b]=i(0),[X,P]=i("00:00"),[y,S]=i(!1),[E,h]=i(!1),[s,j]=i(100),[C,G]=i(!1),k=n(()=>{var e;return(e=r.current)===null||e===void 0?void 0:e.play()},[]),x=n(()=>{var e;return(e=r.current)===null||e===void 0?void 0:e.pause()},[]),J=n(()=>{var e;return(e=r.current)===null||e===void 0?void 0:e.toggle()},[]),K=n(e=>{if(!r.current)return;b(e/w*r.current.duration),v(e)},[]),Q=n(()=>{G(E),x()},[E,x]),W=n(()=>{if(!r.current)return;r.current.seek(_),C&&_<r.current.duration&&k()},[k,_,C]),Y=n(()=>{r.current&&(r.current.toggleMute(),j(r.current.volumn))},[]),u=n(()=>{if(r.current){const e=r.current.current;b(e),v(Math.floor(e/r.current.duration*w))}},[]),U=n(()=>{u(),p.current=globalThis.setInterval(u,250)},[u]),I=n(()=>{r.current&&(r.current.current>=r.current.duration&&u()),p.current&&(globalThis.clearInterval(p.current),p.current=null)},[u]);A(()=>{r.current&&(r.current.volumn=s)},[s]),A(()=>{let e=null;return l&&(async()=>{S(!0),d==null||d(),b(0),v(0),P("00:00"),e=new ie({context:c,onplay:()=>{h(!0),U()},onstop:()=>{h(!1),I()}});const f=await l.data.arrayBuffer();await e.load(f,l.type!=null&&V.extension(l.type)||void 0),S(!1),P(D(e.duration)),m==null||m({sampleRate:e.sampleRate,duration:e.duration}),r.current=e})(),()=>{e&&(h(!1),e.dispose(),r.current=null)}},[l,U,I,d,m,c]);const Z=re(()=>s===0?"mute":s<=50?"volumn-low":"volumn",[s]);return H?o.createElement(ce,{color:R,size:"15px"}):F?o.createElement("div",null,O("common:error")):o.createElement(ve,{className:q},o.createElement("a",{className:`control ${y?"disabled":""}`,onClick:J},y?o.createElement(ae,{size:"16px"}):o.createElement(T,{type:E?"pause":"play"})),o.createElement("div",{className:"slider"},o.createElement(se,{min:0,max:w,step:1,value:L,disabled:y,onChange:K,onChangeStart:Q,onChangeComplete:W})),o.createElement("span",{className:"time"},D(_),"/",X),o.createElement(de,{placement:"top",animation:"shift-away-subtle",interactive:!0,hideOnClick:!1,content:o.createElement(be,{value:s,min:0,max:100,step:1,onChange:j,orientation:"vertical"})},o.createElement("a",{className:"control volumn",onClick:Y},o.createElement(T,{type:Z}))))});export default ye;
