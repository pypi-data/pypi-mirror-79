{{'__init__.r' | rimport}}
library(randomForest)
library(caret)
library(dplyr)

infile       = {{i.infile | quote}}
outmodel     = {{o.outmodel | quote}}
outdir       = {{o.outdir | quote}}
args.plot    = {{args.plot | R}}
args.formula = {{args.formula | R}}
inopts       = {{args.inopts | R}}
devpars      = {{args.devpars | R}}
na           = {{args.na | R}}
prefix       = {{i.infile | stem | quote}}
params       = {{args.params | R}}

indata = read.table.inopts(infile, inopts)
indata[is.na(indata)] = na

cnames = colnames(indata)
if (is.null(cnames)) {
	colnames(indata) = c(paste('X', 1:(ncol(indata)-1)), 'Y')
	cnames = colnames(indata)
}

if (is.null(args.formula)) {
	ycol = cnames[ncol(indata)]
	args.formula = as.formula(paste(cnames[ncol(indata)], '~ .'))
} else {
	ycol = unlist(strsplit(args.formula, '\\s*~\\s*'))[1]
	args.formula = as.formula(args.formula)
}
indata = indata %>% mutate_if(is.character, as.factor)

model.rf = do.call(randomForest, c(list(formula = args.formula, data = indata), params))
model.rf$ycol = ycol
saveRDS(model.rf, outmodel)

if (is.logical(params$importance) && params$importance) {
	vi = varImp(model.rf)
	vi[,1] = scales::rescale(vi[,1], to = c(0, 100))
	write.table(vi, file.path(outdir, 'varimp.txt'), sep = "\t", quote = FALSE)

	# save importance
	write.table(
		round(model.rf$importance[order(model.rf$importance[, 1], decreasing = T), , drop = F], 3),
		file.path(outdir, paste0(prefix, '.importance.txt')),
		col.names = T, row.names = T, quote = F, sep = "\t")

	# plot importance
	{% if args.plot %}
	do.call(png, c(list(file.path(outdir, paste0(prefix, '.importance.png'))), devpars))
	randomForest::varImpPlot(model.rf, main = 'Feature importance')
	dev.off()
	{% endif %}
}
