"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.9.15"
__checksum__ = "e654dc9bce7a66a423fa12b600272c17e21f350083cf0019bcd28b92b4e93b75"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 22), (152, 7), (159, 20), (179, 18), None, (197, 22), (219, 45), (264, 7), (271, 9), (280, 36), (316, 10), (326, 10), (336, 21), None, (357, 50), (407, 8), (415, 9), (424, 19), (443, 13), (456, 14), (470, 14), None, None, (484, 29), (513, 16), (529, 35), (564, 14), (578, 24), (602, 9), None, (611, 25), (636, 20), (656, 8), (664, 13), (677, 10), None, (687, 17), (704, 6), (710, 26), (736, 5), (741, 5), (746, 10), (756, 10), (766, 11), (777, 12), (789, 27), None, (816, 11), (827, 11), (838, 7), (845, 29), (874, 18), (892, 27), (919, 46), (965, 25), (990, 16), (1006, 8), (1014, 5), (1019, 22), (1041, 18), None, (1059, 36), (1095, 15), (1110, 8), (1118, 11), None, (1129, 5), (1134, 16), (1150, 14), (1164, 18), None, (1182, 14), (1196, 18), (1214, 48), (1262, 19), (1281, 5), (1286, 46), (1332, 14), (1346, 14), (1360, 20), None, (1380, 10), (1390, 13), (1403, 10), (1413, 19), None, (1432, 13), (1445, 19), (1464, 5), (1469, 4), (1473, 22), (1495, 10), (1505, 7), (1512, 14), (1526, 21), (1547, 11), (1558, 10), (1568, 12), (1580, 32), None, (1612, 10), (1622, 14), (1636, 12), (1648, 45), (1693, 15), None, (1708, 11), (1719, 23), (1742, 21), (1763, 26), (1789, 6), (1795, 6), (1801, 7), (1808, 5), (1813, 20), (1833, 23), (1856, 24), (1880, 13), (1893, 15), (1908, 19), (1927, 6), (1933, 61), (1994, 44), (2038, 12), (2050, 23), (2073, 16), (2089, 38), (2127, 6), (2133, 12), (2145, 44), (2189, 6), (2195, 41), (2236, 13), (2249, 23), (2272, 30), (2302, 16), (2318, 8), (2326, 15), (2341, 12), (2353, 19), (2372, 21), (2393, 15), None, (2408, 35), (2443, 21), (2464, 17), (2481, 19), (2500, 26), (2526, 5), (2531, 37), (2568, 30), (2598, 16), (2614, 10), (2624, 17), (2641, 23), (2664, 14), (2678, 17), (2695, 8), (2703, 4), (2707, 7), (2714, 29), (2743, 6), (2749, 18), (2767, 27), (2794, 20), (2814, 17), (2831, 19), (2850, 12), (2862, 40), (2902, 40), (2942, 12), (2954, 48), (3002, 25), (3027, 12), None, (3039, 8), (3047, 20), (3067, 19), (3086, 6), (3092, 23), None, (3115, 30), (3145, 33), (3178, 14), (3192, 12), (3204, 27), None, (3231, 26), (3257, 41), (3298, 50), (3348, 15), (3363, 20), (3383, 15), (3398, 21), (3419, 32), (3451, 24), (3475, 20), (3495, 13), (3508, 60), (3568, 19), (3587, 9), (3596, 12), (3608, 12), (3620, 11), (3631, 10), (3641, 48), (3689, 32), None, (3721, 25), (3746, 12), None, (3758, 8), (3766, 8), (3774, 7), None, (3781, 25), (3806, 17), None, (3823, 21), (3844, 35), (3879, 12), (3891, 10), (3901, 36), (3937, 20), (3957, 22), (3979, 23), (4002, 19), (4021, 12), (4033, 5), (4038, 30), (4068, 24), (4092, 14), (4106, 14), (4120, 47), (4167, 46), None, None, (4213, 51), (4264, 42), None, (4306, 14), None, (4320, 15), (4335, 8), (4343, 21), (4364, 6), (4370, 16), (4386, 17)], [(4403, 6337), (10740, 6807), (17547, 7188), (24735, 6090), (30825, 6389), (37214, 6191), (43405, 7020), (50425, 6365), (56790, 6929), (63719, 6135), (69854, 7179), (77033, 6580), (83613, 6846), (90459, 7207), (97666, 6609), (104275, 6802), (111077, 7219), (118296, 6010), (124306, 6361), (130667, 6616), (137283, 7047), (144330, 6668), (150998, 7003), (158001, 6188), (164189, 6504), (170693, 6711), (177404, 6687), (184091, 7036), (191127, 6365), (197492, 6823), (204315, 6920), (211235, 6586), (217821, 6567), (224388, 7113), (231501, 6267), (237768, 6917), (244685, 6269), (250954, 7099), (258053, 6858), (264911, 7005), (271916, 7640), (279556, 6484), (286040, 6414), (292454, 6251), (298705, 6390), (305095, 6285), (311380, 6439), (317819, 7098), (324917, 6530), (331447, 5954), (337401, 6505), (343906, 6747), (350653, 6642), (357295, 6856), (364151, 6944), (371095, 6921), (378016, 6933), (384949, 6054), (391003, 7014), (398017, 5932), (403949, 6726), (410675, 6535), (417210, 6401), (423611, 6917), (430528, 6690), (437218, 6644), (443862, 6365), (450227, 7194), (457421, 6885), (464306, 6831), (471137, 6593), (477730, 6629), (484359, 5783), (490142, 7081), (497223, 7178), (504401, 7188), (511589, 6169), (517758, 7318), (525076, 7106), (532182, 6128), (538310, 6866), (545176, 5815), (550991, 6498), (557489, 6736), (564225, 6515), (570740, 6454), (577194, 6706), (583900, 6718), (590618, 6923), (597541, 6693), (604234, 7348), (611582, 6096), (617678, 6377), (624055, 6646), (630701, 6539), (637240, 7179), (644419, 7025), (651444, 6503), (657947, 6264), (664211, 6235), (670446, 6344), (676790, 6834), (683624, 6302), (689926, 6608), (696534, 6285), (702819, 6945), (709764, 6759), (716523, 7166), (723689, 8087), (731776, 7176), (738952, 7040), (745992, 6604), (752596, 6411), (759007, 6786), (765793, 7006), (772799, 6801), (779600, 6315), (785915, 6422), (792337, 6405), (798742, 7170), (805912, 6958), (812870, 7046), (819916, 7057), (826973, 7027), (834000, 7907), (841907, 6493), (848400, 5945), (854345, 6977), (861322, 6665), (867987, 8164), (876151, 7163), (883314, 6173), (889487, 6902), (896389, 6915), (903304, 6363), (909667, 6827), (916494, 6273), (922767, 6845), (929612, 6571), (936183, 6617), (942800, 6666), (949466, 7331), (956797, 6358), (963155, 6338), (969493, 6680), (976173, 6617), (982790, 6622), (989412, 6902), (996314, 6409), (1002723, 7248), (1009971, 6724), (1016695, 6811), (1023506, 6999), (1030505, 6541), (1037046, 6747), (1043793, 6686), (1050479, 6529), (1057008, 6569), (1063577, 6380), (1069957, 6106), (1076063, 6373), (1082436, 6750), (1089186, 7290), (1096476, 6209), (1102685, 6701), (1109386, 6992), (1116378, 6445), (1122823, 6322), (1129145, 7038), (1136183, 6607), (1142790, 6043), (1148833, 6549), (1155382, 7808), (1163190, 6193), (1169383, 6383), (1175766, 6869), (1182635, 6485), (1189120, 6819), (1195939, 6509), (1202448, 6134), (1208582, 7563), (1216145, 6894), (1223039, 6594), (1229633, 7088), (1236721, 7523), (1244244, 7412), (1251656, 6249), (1257905, 7055), (1264960, 6388), (1271348, 6666), (1278014, 6849), (1284863, 6285), (1291148, 6985), (1298133, 7195), (1305328, 6680), (1312008, 6745), (1318753, 6527), (1325280, 6565), (1331845, 6819), (1338664, 6414), (1345078, 6828), (1351906, 6171), (1358077, 7148), (1365225, 6948), (1372173, 6688), (1378861, 7050), (1385911, 5879), (1391790, 6772), (1398562, 6579), (1405141, 6925), (1412066, 6923), (1418989, 7161), (1426150, 6757), (1432907, 6961), (1439868, 6961), (1446829, 6505), (1453334, 6660), (1459994, 6649), (1466643, 6685), (1473328, 6537), (1479865, 6591), (1486456, 6072), (1492528, 7600), (1500128, 6754), (1506882, 6347), (1513229, 6675), (1519904, 6831), (1526735, 5990), (1532725, 6848), (1539573, 6634), (1546207, 7561), (1553768, 6563), (1560331, 6094), (1566425, 7085), (1573510, 6482), (1579992, 7303), (1587295, 6309), (1593604, 6345), (1599949, 5881), (1605830, 6703), (1612533, 6614), (1619147, 6955), (1626102, 6404), (1632506, 6634), (1639140, 6595), (1645735, 7171), (1652906, 6500), (1659406, 5937), (1665343, 6647), (1671990, 6328), (1678318, 6845), (1685163, 6991), (1692154, 7146), (1699300, 6326), (1705626, 6353), (1711979, 6806)], [(1718785, 736), (1719521, 625), (1720146, 665), (1720811, 757), (1721568, 553), (1722121, 649), (1722770, 671), (1723441, 836), (1724277, 640), (1724917, 667), (1725584, 536), (1726120, 574), (1726694, 758), (1727452, 853), (1728305, 1020), (1729325, 850), (1730175, 1242), (1731417, 653), (1732070, 875), (1732945, 696), (1733641, 757), (1734398, 746), (1735144, 853), (1735997, 731), (1736728, 703), (1737431, 715), (1738146, 955), (1739101, 1131), (1740232, 807), (1741039, 734), (1741773, 922), (1742695, 787), (1743482, 586), (1744068, 746), (1744814, 748), (1745562, 800), (1746362, 659), (1747021, 746), (1747767, 724), (1748491, 1085), (1749576, 695), (1750271, 812), (1751083, 727), (1751810, 719), (1752529, 728), (1753257, 378), (1753635, 929), (1754564, 870), (1755434, 735), (1756169, 568), (1756737, 834), (1757571, 692), (1758263, 780), (1759043, 1012), (1760055, 944), (1760999, 558), (1761557, 661), (1762218, 527), (1762745, 578), (1763323, 751), (1764074, 772), (1764846, 776), (1765622, 1054), (1766676, 915), (1767591, 725), (1768316, 719), (1769035, 767), (1769802, 494), (1770296, 595), (1770891, 556), (1771447, 692), (1772139, 877), (1773016, 596), (1773612, 725), (1774337, 650), (1774987, 717), (1775704, 573), (1776277, 711), (1776988, 787), (1777775, 461), (1778236, 773), (1779009, 629), (1779638, 828), (1780466, 646), (1781112, 603), (1781715, 425), (1782140, 597), (1782737, 746), (1783483, 804), (1784287, 780), (1785067, 853), (1785920, 1092), (1787012, 826), (1787838, 856), (1788694, 725), (1789419, 436), (1789855, 955), (1790810, 857), (1791667, 580), (1792247, 671), (1792918, 728), (1793646, 885), (1794531, 855), (1795386, 571), (1795957, 632), (1796589, 756), (1797345, 395), (1797740, 466), (1798206, 924), (1799130, 918), (1800048, 831), (1800879, 793), (1801672, 654), (1802326, 792), (1803118, 672), (1803790, 699), (1804489, 709), (1805198, 469), (1805667, 722), (1806389, 710), (1807099, 914), (1808013, 679), (1808692, 804), (1809496, 461), (1809957, 691), (1810648, 755), (1811403, 835), (1812238, 926), (1813164, 781), (1813945, 942), (1814887, 802), (1815689, 524), (1816213, 815), (1817028, 630), (1817658, 803), (1818461, 779), (1819240, 717), (1819957, 681), (1820638, 635), (1821273, 673), (1821946, 621), (1822567, 674), (1823241, 694), (1823935, 648), (1824583, 494), (1825077, 603), (1825680, 661), (1826341, 577), (1826918, 717), (1827635, 594), (1828229, 773), (1829002, 514), (1829516, 510), (1830026, 701), (1830727, 628), (1831355, 657), (1832012, 639), (1832651, 870), (1833521, 610), (1834131, 622), (1834753, 903), (1835656, 870), (1836526, 560), (1837086, 695), (1837781, 854), (1838635, 659), (1839294, 692), (1839986, 455), (1840441, 609), (1841050, 684), (1841734, 788), (1842522, 598), (1843120, 932), (1844052, 708), (1844760, 807), (1845567, 721), (1846288, 668), (1846956, 586), (1847542, 664), (1848206, 706), (1848912, 1394), (1850306, 575), (1850881, 662), (1851543, 650), (1852193, 1027), (1853220, 771), (1853991, 798), (1854789, 546), (1855335, 609), (1855944, 823), (1856767, 601), (1857368, 589), (1857957, 828), (1858785, 678), (1859463, 911), (1860374, 810), (1861184, 764), (1861948, 710), (1862658, 868), (1863526, 637), (1864163, 909), (1865072, 662), (1865734, 819), (1866553, 586), (1867139, 742), (1867881, 483), (1868364, 828), (1869192, 823), (1870015, 665), (1870680, 916), (1871596, 787), (1872383, 868), (1873251, 954), (1874205, 1077), (1875282, 887), (1876169, 669), (1876838, 895), (1877733, 731), (1878464, 533), (1878997, 443), (1879440, 794), (1880234, 823), (1881057, 455), (1881512, 1007), (1882519, 513), (1883032, 778), (1883810, 863), (1884673, 792), (1885465, 784), (1886249, 696), (1886945, 806), (1887751, 728), (1888479, 784), (1889263, 607), (1889870, 579), (1890449, 422), (1890871, 666), (1891537, 484), (1892021, 798), (1892819, 880), (1893699, 764), (1894463, 718), (1895181, 658), (1895839, 604), (1896443, 848), (1897291, 495), (1897786, 606), (1898392, 780), (1899172, 494), (1899666, 870), (1900536, 2090), (1902626, 548), (1903174, 707), (1903881, 890), (1904771, 912), (1905683, 510)], [(1906193, 48), None, (1906241, 35), (1906276, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1906318, 42), None, (1906360, 25), (1906385, 44), (1906429, 22), (1906451, 18), None, None, None, None, (1906469, 26), None, None, None, None, (1906495, 21), (1906516, 25), None, None, (1906541, 26), None, None, None, None, (1906567, 44), (1906611, 21), (1906632, 23), None, None, None, None, (1906655, 48), None, None, None, None, None, (1906703, 31), None, None, None, None, (1906734, 42), None, (1906776, 22), None, (1906798, 21), None, (1906819, 26), (1906845, 42), None, None, (1906887, 77), None, None, None, None, None, (1906964, 21), (1906985, 21), None, None, (1907006, 34), (1907040, 42), None, None, None, (1907082, 25), None, None, (1907107, 21), None, None, None, None, None, (1907128, 24), (1907152, 21), None, None, (1907173, 26), None, (1907199, 18), None, (1907217, 54), None, None, None, None, None, None, (1907271, 26), None, (1907297, 19), None, (1907316, 20), None, None, (1907336, 42), (1907378, 42), (1907420, 17), None, (1907437, 26), None, (1907463, 26), None, None, None, (1907489, 26), (1907515, 20), (1907535, 26), None, (1907561, 42), (1907603, 63), None, None, None, (1907666, 40), (1907706, 48), None, None, None, (1907754, 47), None, None, None, None, None, None, None, (1907801, 42), None, (1907843, 55), None, (1907898, 9), None, (1907907, 21), (1907928, 42), None, None, (1907970, 42), (1908012, 82), None, None, (1908094, 42), None, None, None, None, None, None, None, None, None, (1908136, 42), (1908178, 21), (1908199, 21), None, (1908220, 42), (1908262, 25), None, None, (1908287, 21), (1908308, 42), None, None, (1908350, 21), (1908371, 19), (1908390, 26), None, None, None, (1908416, 21), None, None, (1908437, 38), None, (1908475, 22), (1908497, 21), (1908518, 21), None, None, (1908539, 63), None, (1908602, 21), (1908623, 42), None, (1908665, 17), None, None, None, None, (1908682, 21), (1908703, 21), None, None, (1908724, 21), None, None, (1908745, 21), None, (1908766, 26), None, (1908792, 50), None, None, None, (1908842, 50), (1908892, 26), (1908918, 21), (1908939, 21), (1908960, 19), None, (1908979, 35), (1909014, 26), (1909040, 23), (1909063, 21), (1909084, 42), None, None, None, None, None, None, (1909126, 21), None, None, None, (1909147, 21), None, None, (1909168, 90), None, (1909258, 239), (1909497, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
