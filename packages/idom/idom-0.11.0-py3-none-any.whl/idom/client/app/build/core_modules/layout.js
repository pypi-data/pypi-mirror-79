import*as u from"../web_modules/react.js";import*as f from"../web_modules/react-dom.js";import b from"../web_modules/htm.js";import*as l from"../web_modules/fast-json-patch.js";import g from"./event-to-object.js";const c=b.bind(u.createElement),w={};export function mountLayoutWithWebSocket(e,t){if(t.startsWith(".")||t.startsWith("/")){let s=window.location,a;s.protocol==="https:"?a="wss:":a="ws:";let i=a+"//"+s.host;t.startsWith(".")&&(new_url+=s.pathname+"/"),t=i+t}const n=new WebSocket(t);function o(s){n.onmessage=a=>{const[i,$]=JSON.parse(a.data);s(i,$)}}function r(s){n.send(JSON.stringify({header:{},body:{event:s}}))}return mountLayout(e,o,r)}export function mountLayout(e,t,n){const o={current:null};function r(s){o.current=s}f.render(c`<${p} setUpdateHook=${r} sendEvent=${n} />`,e),t((s,a)=>{o.current&&o.current(s,a)})}export default function p({setUpdateHook:e,sendEvent:t}){const[n,o]=u.useState({});return u.useEffect(()=>{e((r,s)=>{o(l.applyPatch(n,s.map(a=>(a.path=r+a.path,a)),void 0,!1).newDocument)})},[n]),n.tagName?c`<${m} sendEvent=${t} model=${n} />`:c`<div />`}function m({sendEvent:e,model:t}){if(t.importSource)return c`<${y} sendEvent=${e} model=${t} />`;{const n=h(e,t),o=d(e,t);return t.children&&t.children.length?c`<${t.tagName} ...${o}>${n}<//>`:c`<${t.tagName} ...${o} />`}}function y({sendEvent:e,model:t}){const n=v(t.importSource.source);if(n){const o=k(n,t.tagName),r=h(e,t),s=d(e,t);return c`<${o} ...${s}>${r}<//>`}else return c`<div>${t.importSource.fallback}<//>`}function h(e,t){return t.children?t.children.map(n=>{switch(typeof n){case"object":return c` <${m} model=${n} sendEvent=${e} /> `;case"string":return n}}):[]}function d(e,t){const n=Object.assign({},t.attributes);return t.eventHandlers&&Object.keys(t.eventHandlers).forEach(o=>{const r=t.eventHandlers[o];n[o]=j(e,r)}),n}function j(e,t){return function(){const n=Array.from(arguments).map(r=>typeof r=="object"&&r.nativeEvent?(t.preventDefault&&r.preventDefault(),t.stopPropagation&&r.stopPropagation(),g(r)):r),o=new Promise((r,s)=>{const a={data:n,target:t.target};e(a),r(a)})}}function v(e){const[t,n]=u.useState(w[e]);return t||E(e).then(n),t}function E(source){return eval(`import('${source}')`).then(e=>e.default?e.default:e,e=>{if(e.stack)return console.log(e),{default:function(){return c`
              <pre>
                  <h1>Error</h1>
                  <code>${[e.stack,e.message]}</code>
                </pre
              >
            `}};throw e})}function k(e,t){const n=t.split("."),o=n.shift();let r=e[o];for(let s=0;s<n.length;s++)r=r[n[s]];return r}
