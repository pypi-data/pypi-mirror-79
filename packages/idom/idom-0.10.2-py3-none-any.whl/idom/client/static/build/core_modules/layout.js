import*as i from"../web_modules/react.js";import*as m from"../web_modules/react-dom.js";import g from"../web_modules/htm.js";import*as p from"../web_modules/fast-json-patch.js";import w from"./event-to-object.js";const a=g.bind(i.createElement),y={};export function renderLayout(t,e){const r=a`<${h} endpoint=${e} />`;return m.render(r,t)}export default function h({endpoint:t}){if(t.startsWith(".")||t.startsWith("/")){let o=window.location,u;o.protocol==="https:"?u="wss:":u="ws:";let f=u+"//"+o.host;t.startsWith(".")&&(new_url+=o.pathname+"/"),t=f+t}const e=i.useMemo(()=>new WebSocket(t),[t]),[r,s]=i.useState({model:{}});e.onmessage=o=>{const[u,f]=JSON.parse(o.data);s({model:p.applyPatch(r.model,f.map(l=>(l.path=u+l.path,l)),void 0,!1).newDocument})};const n=o=>{e.send(JSON.stringify(o))},c=o=>{n({header:{},body:{event:o}})};return r.model.tagName?a`<${d} sendEvent=${c} model=${r.model} />`:a`<div />`}function d({sendEvent:t,model:e}){if(e.importSource)return a`<${j} sendEvent=${t} model=${e} />`;{const r=$(t,e),s=b(t,e);return e.children&&e.children.length?a`<${e.tagName} ...${s}>${r}<//>`:a`<${e.tagName} ...${s} />`}}function j({sendEvent:t,model:e}){const r=E(e.importSource.source);if(r){const s=S(r,e.tagName),n=$(t,e),c=b(t,e);return a`<${s} ...${c}>${n}<//>`}else return a`<div>${e.importSource.fallback}<//>`}function $(t,e){return e.children?e.children.map(r=>{switch(typeof r){case"object":return a` <${d} model=${r} sendEvent=${t} /> `;case"string":return r}}):[]}function b(t,e){const r=Object.assign({},e.attributes);return e.eventHandlers&&Object.keys(e.eventHandlers).forEach(s=>{const n=e.eventHandlers[s];r[s]=v(t,n)}),r}function v(t,e){return function(){const r=Array.from(arguments).map(n=>typeof n=="object"&&n.nativeEvent?(e.preventDefault&&n.preventDefault(),e.stopPropagation&&n.stopPropagation(),w(n)):n),s=new Promise((n,c)=>{const o={data:r,target:e.target};t(o),n(o)})}}function E(t){const[e,r]=i.useState(y[t]);return e||P(t).then(r),e}function P(source){return eval(`import('${source}')`).then(t=>t.default?t.default:t,t=>{if(t.stack)return console.log(t),{default:function(){return a`
              <pre>
                  <h1>Error</h1>
                  <code>${[t.stack,t.message]}</code>
                </pre
              >
            `}};throw t})}function S(t,e){const r=e.split("."),s=r.shift();let n=t[s];for(let c=0;c<r.length;c++)n=n[r[c]];return n}
