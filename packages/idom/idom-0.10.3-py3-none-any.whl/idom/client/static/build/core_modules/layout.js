import*as i from"../web_modules/react.js";import*as l from"../web_modules/react-dom.js";import g from"../web_modules/htm.js";import*as p from"../web_modules/fast-json-patch.js";import w from"./event-to-object.js";const c=g.bind(i.createElement),y={};export function mountLayoutWithWebSocket(e,t){if(t.startsWith(".")||t.startsWith("/")){let a=window.location,u;a.protocol==="https:"?u="wss:":u="ws:";let f=u+"//"+a.host;t.startsWith(".")&&(new_url+=a.pathname+"/"),t=f+t}const r=new WebSocket(t);function s(a){r.onmessage=u=>{const[f,$]=JSON.parse(u.data);a(f,$)}}function n(a){r.send(JSON.stringify({header:{},body:{event:a}}))}const o=c`<${m}
    registerUpdateCallback=${s}
    sendCallback=${n}
  />`;return l.render(o,e)}export default function m({registerUpdateCallback:e,sendCallback:t}){const[r,s]=i.useState({});return i.useEffect(()=>{e((n,o)=>{s(p.applyPatch(r,o.map(a=>(a.path=n+a.path,a)),void 0,!1).newDocument)})},[r]),r.tagName?c`<${h} sendEvent=${t} model=${r} />`:c`<div />`}function h({sendEvent:e,model:t}){if(t.importSource)return c`<${j} sendEvent=${e} model=${t} />`;{const r=d(e,t),s=b(e,t);return t.children&&t.children.length?c`<${t.tagName} ...${s}>${r}<//>`:c`<${t.tagName} ...${s} />`}}function j({sendEvent:e,model:t}){const r=E(t.importSource.source);if(r){const s=P(r,t.tagName),n=d(e,t),o=b(e,t);return c`<${s} ...${o}>${n}<//>`}else return c`<div>${t.importSource.fallback}<//>`}function d(e,t){return t.children?t.children.map(r=>{switch(typeof r){case"object":return c` <${h} model=${r} sendEvent=${e} /> `;case"string":return r}}):[]}function b(e,t){const r=Object.assign({},t.attributes);return t.eventHandlers&&Object.keys(t.eventHandlers).forEach(s=>{const n=t.eventHandlers[s];r[s]=v(e,n)}),r}function v(e,t){return function(){const r=Array.from(arguments).map(n=>typeof n=="object"&&n.nativeEvent?(t.preventDefault&&n.preventDefault(),t.stopPropagation&&n.stopPropagation(),w(n)):n),s=new Promise((n,o)=>{const a={data:r,target:t.target};e(a),n(a)})}}function E(e){const[t,r]=i.useState(y[e]);return t||k(e).then(r),t}function k(source){return eval(`import('${source}')`).then(e=>e.default?e.default:e,e=>{if(e.stack)return console.log(e),{default:function(){return c`
              <pre>
                  <h1>Error</h1>
                  <code>${[e.stack,e.message]}</code>
                </pre
              >
            `}};throw e})}function P(e,t){const r=t.split("."),s=r.shift();let n=e[s];for(let o=0;o<r.length;o++)n=n[r[o]];return n}
