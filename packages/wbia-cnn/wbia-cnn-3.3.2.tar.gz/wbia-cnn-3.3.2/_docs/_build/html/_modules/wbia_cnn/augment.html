
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia_cnn.augment &#8212; wbia-cnn 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia_cnn.augment</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core functions for data augmentation</span>


<span class="sd">References:</span>
<span class="sd">    https://github.com/benanne/kaggle-ndsb/blob/master/data.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">rot_transforms</span> <span class="o">=</span> <span class="p">[</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>

<span class="n">flip_transforms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">]</span>

<span class="n">all_transforms</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">rot_transforms</span><span class="p">,</span>
    <span class="n">flip_transforms</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">default_augmentation_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;zoom_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
    <span class="s1">&#39;rotation_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">),</span>
    <span class="s1">&#39;shear_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;translation_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s1">&#39;do_flip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;allow_stretch&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">TAU</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>


<span class="n">RAND_AFF_ARGS_DEFAULTS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">zoom_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
    <span class="n">max_tx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_ty</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_shear</span><span class="o">=</span><span class="n">TAU</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">max_theta</span><span class="o">=</span><span class="n">TAU</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">enable_flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">enable_stretch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="random_affine_args"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.random_affine_args">[docs]</a><span class="k">def</span> <span class="nf">random_affine_args</span><span class="p">(</span>
    <span class="n">zoom_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
    <span class="n">max_tx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_ty</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">max_shear</span><span class="o">=</span><span class="n">TAU</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">max_theta</span><span class="o">=</span><span class="n">TAU</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">enable_flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">enable_stretch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-random_affine_args</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">        &gt;&gt;&gt; zoom_range = (0.9090909090909091, 1.1)</span>
<span class="sd">        &gt;&gt;&gt; max_tx = 4</span>
<span class="sd">        &gt;&gt;&gt; max_ty = 4</span>
<span class="sd">        &gt;&gt;&gt; max_shear = np.pi</span>
<span class="sd">        &gt;&gt;&gt; enable_rotate = True</span>
<span class="sd">        &gt;&gt;&gt; enable_flip = True</span>
<span class="sd">        &gt;&gt;&gt; enable_stretch = True</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; affine_args = random_affine_args(zoom_range, max_tx, max_ty, max_shear, enable_rotate, enable_flip, enable_stretch, rng)</span>
<span class="sd">        &gt;&gt;&gt; sx, sy, theta, shear, tx, ty = affine_args</span>
<span class="sd">        &gt;&gt;&gt; Aff = vt.affine_mat3x3(sx, sy, theta, shear, tx, ty)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.numpy_str2(Aff)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        np.array([[ 0.972,  0.566,  0.359],</span>
<span class="sd">                  [ 0.308,  0.848, -0.611],</span>
<span class="sd">                  [ 0.   ,  0.   ,  1.   ]])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: use vt.random_affine_args</span>

    <span class="k">if</span> <span class="n">zoom_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_zoom_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zoom_range</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">enable_stretch</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">log_zoom_range</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">log_zoom_range</span><span class="p">))</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">log_zoom_range</span><span class="p">))</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">max_theta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">max_theta</span><span class="p">,</span> <span class="n">max_theta</span><span class="p">)</span>
    <span class="n">shear</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">max_shear</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">max_shear</span><span class="p">,</span> <span class="n">max_shear</span><span class="p">)</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">max_tx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">max_tx</span><span class="p">,</span> <span class="n">max_tx</span><span class="p">)</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">max_ty</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">max_ty</span><span class="p">,</span> <span class="n">max_ty</span><span class="p">)</span>

    <span class="n">flip</span> <span class="o">=</span> <span class="n">enable_flip</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># flip half of the time</span>
    <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
        <span class="c1"># shear 180 degrees + rotate 180 == flip</span>
        <span class="n">theta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">shear</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="n">affine_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">affine_args</span></div>
    <span class="c1"># Aff = vt.affine_mat3x3(sx, sy, theta, shear, tx, ty)</span>
    <span class="c1"># return Aff</span>


<div class="viewcode-block" id="random_affine_kwargs"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.random_affine_kwargs">[docs]</a><span class="k">def</span> <span class="nf">random_affine_kwargs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">affine_args</span> <span class="o">=</span> <span class="n">random_affine_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">affine_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">,</span> <span class="s1">&#39;sy&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;shear&#39;</span><span class="p">,</span> <span class="s1">&#39;tx&#39;</span><span class="p">,</span> <span class="s1">&#39;ty&#39;</span><span class="p">]</span>
    <span class="n">affine_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">affine_keys</span><span class="p">,</span> <span class="n">affine_args</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">affine_kw</span></div>


<div class="viewcode-block" id="affine_perterb"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.affine_perterb">[docs]</a><span class="k">def</span> <span class="nf">affine_perterb</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        img (ndarray[uint8_t, ndim=2]):  image data</span>
<span class="sd">        rng (module):</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: img_warped</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-affine_perterb --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">        &gt;&gt;&gt; img_fpath = ut.grab_test_imgpath(&#39;carl.jpg&#39;)</span>
<span class="sd">        &gt;&gt;&gt; img = vt.imread(img_fpath)</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random   #.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; img_warped = affine_perterb(img, rng)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; pt.imshow(img_warped)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="n">affine_args</span> <span class="o">=</span> <span class="n">random_affine_args</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
    <span class="n">h1</span><span class="p">,</span> <span class="n">w1</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">w1</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">Aff</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">affine_around_mat3x3</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="o">*</span><span class="n">affine_args</span><span class="p">)</span>
    <span class="n">dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">h1</span><span class="p">)</span>
    <span class="n">img_warped</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">Aff</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dsize</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">,</span> <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">img_warped</span></div>


<div class="viewcode-block" id="test_transforms"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.test_transforms">[docs]</a><span class="k">def</span> <span class="nf">test_transforms</span><span class="p">():</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-test_transforms --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; test_transforms()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">ingest_data</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">draw_results</span>

    <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ingest_data</span><span class="o">.</span><span class="n">testdata_patchmatch</span><span class="p">()</span>
    <span class="n">cv2_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">convert_theano_images_to_cv2_images</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">patches_</span> <span class="o">=</span> <span class="n">cv2_data</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">transform_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">all_transforms</span><span class="p">)</span>

    <span class="n">num_random</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_random</span><span class="p">):</span>
        <span class="n">affine_kw</span> <span class="o">=</span> <span class="n">random_affine_kwargs</span><span class="p">()</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">affine_warp_around_center</span><span class="p">,</span> <span class="o">**</span><span class="n">affine_kw</span><span class="p">)</span>
        <span class="n">transform_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="n">orig_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">warped_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">name_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_</span><span class="p">,</span> <span class="n">transform_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_partial_func_name</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">warped</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="n">orig_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="n">name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">warped_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warped</span><span class="p">)</span>

    <span class="n">index_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_list</span><span class="p">)))</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">draw_results</span><span class="o">.</span><span class="n">get_patch_sample_img</span><span class="p">(</span>
        <span class="n">orig_list</span><span class="p">,</span>
        <span class="n">warped_list</span><span class="p">,</span>
        <span class="n">label_list</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">name_list</span><span class="p">},</span>
        <span class="n">index_list</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">stacked_img</span><span class="p">,</span> <span class="n">stacked_offsets</span><span class="p">,</span> <span class="n">stacked_sfs</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">quit_if_noshow</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

    <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stacked_img</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">show_if_requested</span><span class="p">()</span></div>


<div class="viewcode-block" id="augment_siamese_patches"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.augment_siamese_patches">[docs]</a><span class="k">def</span> <span class="nf">augment_siamese_patches</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-augment_siamese_patches --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn import ingest_data, utils, draw_results</span>
<span class="sd">        &gt;&gt;&gt; data, labels = ingest_data.testdata_patchmatch()</span>
<span class="sd">        &gt;&gt;&gt; cv2_data = utils.convert_theano_images_to_cv2_images(data)</span>
<span class="sd">        &gt;&gt;&gt; batch_size = 128</span>
<span class="sd">        &gt;&gt;&gt; Xb, yb = cv2_data[0:batch_size], labels[0:batch_size // 2]</span>
<span class="sd">        &gt;&gt;&gt; Xb1, yb1 = augment_siamese_patches(Xb.copy(), yb.copy())</span>
<span class="sd">        &gt;&gt;&gt; modified_indexes = np.where((Xb1 != Xb).sum(-1).sum(-1).sum(-1) &gt; 0)[0]</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; #z = draw_results.get_sample_pairimg_from_X(Xb, 1)</span>
<span class="sd">        &gt;&gt;&gt; pt.imshow(Xb[modified_indexes[0]], pnum=(2, 2, 1), title=&#39;before&#39;)</span>
<span class="sd">        &gt;&gt;&gt; pt.imshow(Xb1[modified_indexes[0]], pnum=(2, 2, 2), title=&#39;after&#39;)</span>
<span class="sd">        &gt;&gt;&gt; pt.imshow(Xb[modified_indexes[1]], pnum=(2, 2, 3))</span>
<span class="sd">        &gt;&gt;&gt; pt.imshow(Xb1[modified_indexes[1]], pnum=(2, 2, 4))</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Rotate corresponding patches together</span>
    <span class="n">Xb1</span><span class="p">,</span> <span class="n">Xb2</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">Xb</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rot_transforms</span> <span class="o">=</span> <span class="p">[</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="n">flip_transforms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">]</span>
    <span class="n">prob_rotate</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">prob_flip</span> <span class="o">=</span> <span class="mf">0.3</span>

    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb1</span><span class="p">)</span>

    <span class="c1"># Determine which examples will be augmented</span>
    <span class="n">rotate_flags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">prob_rotate</span>
    <span class="n">flip_flags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">prob_flip</span>

    <span class="c1"># Determine which functions to use</span>
    <span class="n">rot_fn_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">rot_transforms</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rot_transforms</span><span class="p">))]</span> <span class="k">if</span> <span class="n">flag</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">rotate_flags</span>
    <span class="p">]</span>
    <span class="n">flip_fn_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">flip_transforms</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flip_transforms</span><span class="p">))]</span> <span class="k">if</span> <span class="n">flag</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flip_flags</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">func_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rot_fn_list</span><span class="p">,</span> <span class="n">flip_fn_list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">func_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span></div>


<div class="viewcode-block" id="stacked_img_pairs"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.stacked_img_pairs">[docs]</a><span class="k">def</span> <span class="nf">stacked_img_pairs</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">modified_indexes</span><span class="p">,</span> <span class="n">label_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">draw_results</span>

    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modified_indexes</span><span class="p">)</span>
    <span class="c1"># np.random.shuffle(modified_indexes)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modified_indexes</span><span class="p">),</span> <span class="n">num</span><span class="p">)</span>
    <span class="n">patch_list1</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">patch_list2</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">per_row</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">per_row</span><span class="p">)</span>
    <span class="c1"># print(&#39;len(patch_list1) = %r&#39; % (len(patch_list1),))</span>
    <span class="c1"># print(&#39;len(patch_list2) = %r&#39; % (len(patch_list2),))</span>
    <span class="c1"># print(&#39;len(modified_indexes) = %r&#39; % (len(modified_indexes),))</span>
    <span class="c1"># print(&#39;modified_indexes = %r&#39; % ((modified_indexes),))</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">draw_results</span><span class="o">.</span><span class="n">get_patch_sample_img</span><span class="p">(</span>
        <span class="n">patch_list1</span><span class="p">,</span> <span class="n">patch_list2</span><span class="p">,</span> <span class="n">label_list</span><span class="p">,</span> <span class="p">{},</span> <span class="n">modified_indexes</span><span class="p">,</span> <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">per_row</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">stacked_img</span><span class="p">,</span> <span class="n">stacked_offsets</span><span class="p">,</span> <span class="n">stacked_sfs</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="k">return</span> <span class="n">stacked_img</span></div>


<div class="viewcode-block" id="show_augmented_patches"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.show_augmented_patches">[docs]</a><span class="k">def</span> <span class="nf">show_augmented_patches</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">Xb_</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="n">data_per_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shadows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">    std_ = center_std</span>
<span class="sd">    mean_ = center_mean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">Xb_old</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">rectify_to_float01</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
    <span class="n">Xb_new</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">rectify_to_float01</span><span class="p">(</span><span class="n">Xb_</span><span class="p">)</span>

    <span class="c1"># only look at ones that were actually augmented</span>
    <span class="n">sample1</span> <span class="o">=</span> <span class="n">Xb_old</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">data_per_label</span><span class="p">]</span>
    <span class="n">sample2</span> <span class="o">=</span> <span class="n">Xb_new</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="n">data_per_label</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">sample1</span> <span class="o">-</span> <span class="n">sample2</span><span class="p">))</span>
    <span class="n">diff_batches</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">modified_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diff_batches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;modified_indexes = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modified_indexes</span><span class="p">,))</span>
    <span class="c1"># modified_indexes = np.arange(num_examples)</span>

    <span class="n">Xb_old</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">rectify_to_uint8</span><span class="p">(</span><span class="n">Xb_old</span><span class="p">)</span>
    <span class="n">Xb_new</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">rectify_to_uint8</span><span class="p">(</span><span class="n">Xb_new</span><span class="p">)</span>

    <span class="c1"># Group data into n-tuples</span>
    <span class="n">grouped_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb_</span><span class="p">),</span> <span class="n">data_per_label</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_per_label</span><span class="p">)]</span>
    <span class="n">data_lists_old</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">Xb_old</span><span class="p">,</span> <span class="n">grouped_idxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data_lists_new</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">Xb_new</span><span class="p">,</span> <span class="n">grouped_idxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">six</span>

    <span class="c1"># chunck_sizes = (4, 10)</span>
    <span class="kn">import</span> <span class="nn">utool</span>

    <span class="k">with</span> <span class="n">utool</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
        <span class="n">chunk_sizes</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">get_square_row_cols</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">modified_indexes</span><span class="p">),</span> <span class="n">max_cols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">iter_multichunks</span><span class="p">(</span><span class="n">modified_indexes</span><span class="p">,</span> <span class="n">chunk_sizes</span><span class="p">)</span>
        <span class="n">multiindices</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">_iter</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">draw_results</span>

        <span class="n">tup</span> <span class="o">=</span> <span class="n">draw_results</span><span class="o">.</span><span class="n">get_patch_multichunks</span><span class="p">(</span><span class="n">data_lists_old</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="p">{},</span> <span class="n">multiindices</span><span class="p">)</span>
        <span class="n">orig_stack</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># stacked_img, stacked_offsets, stacked_sfs = tup</span>

        <span class="n">tup</span> <span class="o">=</span> <span class="n">draw_results</span><span class="o">.</span><span class="n">get_patch_multichunks</span><span class="p">(</span><span class="n">data_lists_new</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="p">{},</span> <span class="n">multiindices</span><span class="p">)</span>
        <span class="n">warp_stack</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># stacked_img, stacked_offsets, stacked_sfs = tup</span>

    <span class="c1"># orig_stack = stacked_img_pairs(Xb_old, modified_indexes, yb)</span>
    <span class="c1"># warp_stack = stacked_img_pairs(Xb_new, modified_indexes, yb_)</span>
    <span class="k">if</span> <span class="n">shadows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># hack</span>
        <span class="n">shadow_stack</span> <span class="o">=</span> <span class="n">stacked_img_pairs</span><span class="p">(</span><span class="n">shadows</span><span class="p">,</span> <span class="n">modified_indexes</span><span class="p">,</span> <span class="n">yb_</span><span class="p">)</span>

    <span class="n">fnum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
    <span class="c1"># next_pnum = pt.make_pnum_nextgen(nRows=2 + (shadows is not None), nCols=1)</span>
    <span class="n">next_pnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nCols</span><span class="o">=</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">shadows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="n">nRows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">orig_stack</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;before&#39;</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">warp_stack</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;after&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shadows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">shadow_stack</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;shadow_stack&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="testdata_augment"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.testdata_augment">[docs]</a><span class="k">def</span> <span class="nf">testdata_augment</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">ingest_data</span><span class="p">,</span> <span class="n">utils</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">ingest_data</span><span class="o">.</span><span class="n">grab_siam_dataset</span><span class="p">()</span>
    <span class="n">cv2_data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_xy_sample</span><span class="p">(</span><span class="n">cv2_data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Xb</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">rectify_to_float01</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
    <span class="n">Xb_orig</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">yb_orig</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Xb_orig</span><span class="p">,</span> <span class="n">yb_orig</span><span class="p">,</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span></div>


<div class="viewcode-block" id="augment_affine"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.augment_affine">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">augment_affine</span><span class="p">(</span>
    <span class="n">Xb</span><span class="p">,</span>
    <span class="n">yb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">,</span>
    <span class="n">data_per_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">affperterb_ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">aug_prop</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-augment_affine --show</span>
<span class="sd">        utprof.py -m wbia_cnn.augment --test-augment_affine</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">        &gt;&gt;&gt; model, dataset = mnist.testdata_mnist()</span>
<span class="sd">        &gt;&gt;&gt; X, y = dataset.subset(&#39;test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; batch_size = 1000</span>
<span class="sd">        &gt;&gt;&gt; Xb = (X[0:batch_size] / 255).astype(np.float32)</span>
<span class="sd">        &gt;&gt;&gt; yb = y[0:batch_size]</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; data_per_label = 1</span>
<span class="sd">        &gt;&gt;&gt; inplace = False</span>
<span class="sd">        &gt;&gt;&gt; affperterb_ranges = dict(</span>
<span class="sd">        &gt;&gt;&gt;     zoom_range=(1.0, 1.3),</span>
<span class="sd">        &gt;&gt;&gt;     max_tx=2,</span>
<span class="sd">        &gt;&gt;&gt;     max_ty=2,</span>
<span class="sd">        &gt;&gt;&gt;     max_shear=TAU / 32,</span>
<span class="sd">        &gt;&gt;&gt;     max_theta=None,</span>
<span class="sd">        &gt;&gt;&gt;     enable_stretch=True,</span>
<span class="sd">        &gt;&gt;&gt;     enable_flip=False,</span>
<span class="sd">        &gt;&gt;&gt; )</span>
<span class="sd">        &gt;&gt;&gt; Xb_, yb_ = augment_affine(Xb, yb, data_per_label=data_per_label, rng=rng, affperterb_ranges=affperterb_ranges)</span>
<span class="sd">        &gt;&gt;&gt; assert Xb_ is not Xb</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; pt.qt4ensure()</span>
<span class="sd">        &gt;&gt;&gt; show_augmented_patches(Xb, Xb_, yb, yb_, data_per_label=data_per_label)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">Xb_</span> <span class="o">=</span> <span class="n">Xb</span> <span class="k">if</span> <span class="n">inplace</span> <span class="k">else</span> <span class="n">Xb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">yb_</span> <span class="o">=</span> <span class="n">yb</span> <span class="k">if</span> <span class="n">inplace</span> <span class="ow">or</span> <span class="n">yb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">yb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">nGroups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb_</span><span class="p">)</span> <span class="o">//</span> <span class="n">data_per_label</span>

    <span class="c1"># Make the same affine parameters for each group</span>
    <span class="c1"># Determine which groups will be augmented</span>
    <span class="n">affperterb_flags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nGroups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">aug_prop</span>
    <span class="c1"># Build augmentation params for each group</span>
    <span class="k">if</span> <span class="n">affperterb_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">affperterb_ranges</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">zoom_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_ty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_shear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">enable_flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">enable_stretch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># affperterb_ranges.update(</span>
    <span class="c1">#    dict(</span>
    <span class="c1">#        #zoom_range=(1.0, 1.7),</span>
    <span class="c1">#        zoom_range=(1.0, 1.3),</span>
    <span class="c1">#        #zoom_range=(.7, 1.7),</span>
    <span class="c1">#        max_tx=2,</span>
    <span class="c1">#        max_ty=2,</span>
    <span class="c1">#        max_shear=TAU / 32,</span>
    <span class="c1">#        max_theta=TAU,</span>
    <span class="c1">#        enable_stretch=True,</span>
    <span class="c1">#        enable_flip=True,</span>
    <span class="c1">#    )</span>
    <span class="c1"># )</span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">affperterb_flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">affperterb_kw_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">random_affine_kwargs</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="o">**</span><span class="n">affperterb_ranges</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span>
    <span class="p">]</span>

    <span class="c1"># Partition data into groups</span>
    <span class="c1"># grouped_slices = [slice(n, len(Xb_), data_per_label)</span>
    <span class="c1">#                  for n in range(data_per_label)]</span>
    <span class="n">grouped_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb_</span><span class="p">),</span> <span class="n">data_per_label</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_per_label</span><span class="p">)]</span>

    <span class="c1"># Take only the groups that were augmented</span>
    <span class="n">aug_grouped</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">grouped_idxs</span><span class="p">),</span> <span class="n">index_list</span><span class="p">)</span>

    <span class="n">borderMode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span>
    <span class="c1"># borderMode = cv2.BORDER_REPLICATE</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
    <span class="n">num_channels</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">borderValue</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_channels</span>
    <span class="k">for</span> <span class="n">xs</span><span class="p">,</span> <span class="n">affkw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aug_grouped</span><span class="p">,</span> <span class="n">affperterb_kw_list</span><span class="p">):</span>
        <span class="c1"># Modify each index in the group with the same params</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="n">Xref</span> <span class="o">=</span> <span class="n">Xb_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">Xref</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">affine_warp_around_center</span><span class="p">(</span>
                <span class="n">Xref</span><span class="p">,</span>
                <span class="n">borderMode</span><span class="o">=</span><span class="n">borderMode</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span>
                <span class="n">borderValue</span><span class="o">=</span><span class="n">borderValue</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">Xref</span><span class="p">,</span>
                <span class="o">**</span><span class="n">affkw</span>
            <span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">Xref</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">Xref</span><span class="p">)</span>
            <span class="c1"># Modify the batch</span>
            <span class="n">Xb_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xref</span>
    <span class="c1"># Xb_ = Xb_.astype(np.float32)</span>
    <span class="k">return</span> <span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span></div>


<div class="viewcode-block" id="augment_affine_siam"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.augment_affine_siam">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">augment_affine_siam</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-augment_affine --show --db PZ_MTEST</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">        &gt;&gt;&gt; model, dataset = mnist.testdata_mnist()</span>
<span class="sd">        &gt;&gt;&gt; X, y = dataset.subset(&#39;test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; Xb = (X[0:8] / 255).astype(np.float32)</span>
<span class="sd">        &gt;&gt;&gt; yb = y[0:8]</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; Xb_, yb_ = augment_affine(Xb, yb, rng=rng)</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; pt.qt4ensure()</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; show_augmented_patches(Xb, Xb_, yb, yb_)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn import ingest_data, utils, draw_results</span>
<span class="sd">        &gt;&gt;&gt; Xb_orig, yb_orig, Xb, yb = testdata_augment()</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; Xb, yb = augment_affine(Xb, yb, rng=rng)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; show_augmented_patches(Xb_orig, Xb, yb_orig, yb)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">Xb1</span><span class="p">,</span> <span class="n">Xb2</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">Xb</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">affprob_perterb</span> <span class="o">=</span> <span class="mf">0.7</span>

    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb1</span><span class="p">)</span>
    <span class="c1"># Determine which examples will be augmented</span>
    <span class="n">affperterb_flags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">affprob_perterb</span>

    <span class="n">affperterb_ranges</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">zoom_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_ty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_shear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_stretch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">affperterb_ranges</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="c1"># zoom_range=(1.0, 1.7),</span>
            <span class="n">zoom_range</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">),</span>
            <span class="c1"># zoom_range=(.7, 1.7),</span>
            <span class="n">max_tx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">max_ty</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">max_shear</span><span class="o">=</span><span class="n">TAU</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span>
            <span class="n">max_theta</span><span class="o">=</span><span class="n">TAU</span><span class="p">,</span>
            <span class="n">enable_stretch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">enable_flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">affperterb_flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">affperterb_kw_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">random_affine_kwargs</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="o">**</span><span class="n">affperterb_ranges</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span>
    <span class="p">]</span>

    <span class="c1"># lighting_perterb_ranges = dict(</span>
    <span class="c1">#    darken=(-.01, .01),</span>
    <span class="c1"># )</span>

    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="c1"># borderMode = cv2.BORDER_REFLECT101</span>
    <span class="c1"># borderMode = cv2.BORDER_REFLECT_101</span>
    <span class="c1"># borderMode = cv2.BORDER_WRAP</span>
    <span class="c1"># borderMode = cv2.BORDER_CONSTANT</span>
    <span class="c1"># borderMode = cv2.BORDER_REFLECT</span>
    <span class="n">borderMode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span>
    <span class="c1"># borderMode = cv2.BORDER_REPLICATE</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
    <span class="n">borderValue</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="n">Xb1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">kw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span> <span class="n">affperterb_kw_list</span><span class="p">):</span>
        <span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">affine_warp_around_center</span><span class="p">(</span>
                <span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                <span class="n">borderMode</span><span class="o">=</span><span class="n">borderMode</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span>
                <span class="n">borderValue</span><span class="o">=</span><span class="n">borderValue</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kw</span>
            <span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">affine_warp_around_center</span><span class="p">(</span>
                <span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                <span class="n">borderMode</span><span class="o">=</span><span class="n">borderMode</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span>
                <span class="n">borderValue</span><span class="o">=</span><span class="n">borderValue</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kw</span>
            <span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="c1"># bad_xs = np.where((Xb &gt; 1).sum(axis=-1).sum(axis=-1).sum(axis=-1) &gt; 0)[0]</span>
    <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span></div>


<div class="viewcode-block" id="augment_shadow"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.augment_shadow">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">augment_shadow</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">,</span> <span class="n">return_shadowmaps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-augment_shadow --show --db PZ_MTEST</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn import ingest_data, utils, draw_results</span>
<span class="sd">        &gt;&gt;&gt; Xb_orig, yb_orig, Xb, yb = testdata_augment()</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; Xb, yb, shadows = augment_shadow(Xb, yb, rng=rng, return_shadowmaps=True)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; show_augmented_patches(Xb_orig, Xb, yb_orig, yb, shadows)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="c1"># Rotate corresponding patches together</span>
    <span class="n">Xb1</span><span class="p">,</span> <span class="n">Xb2</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">Xb</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">perlin_perteb</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">perlin_noise01</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="c1"># scale = 128.0</span>
        <span class="c1"># scale = 80.0</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">perlin_noise</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">noise</span>

    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb1</span><span class="p">)</span>

    <span class="n">perlinperterb_flags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">perlin_perteb</span>

    <span class="c1"># perlin_min = 0.2</span>
    <span class="c1"># perlin_max = 0.9</span>
    <span class="c1"># perlin_range = perlin_max - perlin_min</span>
    <span class="k">if</span> <span class="n">return_shadowmaps</span><span class="p">:</span>
        <span class="n">shadows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Xb</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">shadows1</span><span class="p">,</span> <span class="n">shadows2</span> <span class="o">=</span> <span class="n">shadows</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">shadows</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">perlinperterb_flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">img1</span> <span class="o">=</span> <span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># TODO: TAKE IN NORMALIZED POINTS</span>
        <span class="n">noise1</span> <span class="o">=</span> <span class="n">perlin_noise01</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">noise2</span> <span class="o">=</span> <span class="n">perlin_noise01</span><span class="p">(</span><span class="n">img2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># noise1 = np.clip(noise1 / .7, 0, 1)</span>
        <span class="c1"># noise2 = np.clip(noise2 / .7, 0, 1)</span>
        <span class="n">noise1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">noise1</span> <span class="o">**</span> <span class="mf">0.7</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">noise2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">noise2</span> <span class="o">**</span> <span class="mf">0.7</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_shadowmaps</span><span class="p">:</span>
            <span class="n">shadows1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise1</span>
            <span class="n">shadows2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise2</span>

        <span class="c1"># noise1[noise1 &gt; .6] = 1</span>
        <span class="c1"># noise2[noise2 &gt; .6] = 1</span>

        <span class="c1"># alpha1 = ((rng.rand() * perlin_range) + perlin_min)</span>
        <span class="c1"># alpha2 = ((rng.rand() * perlin_range) + perlin_min)</span>
        <span class="c1"># Xb1[index] = img1 ** (noise1 * alpha1)</span>
        <span class="c1"># Xb2[index] = img2 ** (noise2 * alpha2)</span>
        <span class="c1"># alpha1 = alpha2 = .5</span>
        <span class="n">alpha1</span> <span class="o">=</span> <span class="n">alpha2</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">blend_images_multiply</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">noise1</span><span class="p">,</span> <span class="n">alpha1</span><span class="p">)</span>
        <span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">blend_images_multiply</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">noise2</span><span class="p">,</span> <span class="n">alpha2</span><span class="p">)</span>

        <span class="c1"># Linear Burn</span>
        <span class="c1"># Xb1[index] = np.clip(img1 + noise1 - 1.0, 0, 1)</span>
        <span class="c1"># Xb2[index] = np.clip(img2 + noise2 - 1.0, 0, 1)</span>

        <span class="c1"># Xb1[index] = vt.blend_images_average(img1, noise1, alpha1)</span>
        <span class="c1"># Xb2[index] = vt.blend_images_average(img2, noise2, alpha2)</span>

        <span class="c1"># Xb1[index] = noise1</span>
        <span class="c1"># Xb2[index] = noise2</span>
    <span class="c1"># with ut.embed_on_exception_context:</span>
    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="c1"># bad_xs = np.where((Xb &gt; 1).sum(axis=-1).sum(axis=-1).sum(axis=-1) &gt; 0)[0]</span>
    <span class="k">if</span> <span class="n">return_shadowmaps</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">shadows</span>
    <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span></div>


<div class="viewcode-block" id="augment_gamma"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.augment_gamma">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">augment_gamma</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-augment_gamma --show --db PZ_MTEST</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn import ingest_data, utils, draw_results</span>
<span class="sd">        &gt;&gt;&gt; Xb_orig, yb_orig, Xb, yb = testdata_augment()</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; Xb, yb = augment_gamma(Xb, yb, rng=rng)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; show_augmented_patches(Xb_orig, Xb, yb_orig, yb)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># import vtool as vt</span>
    <span class="c1"># Rotate corresponding patches together</span>
    <span class="n">Xb1</span><span class="p">,</span> <span class="n">Xb2</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">Xb</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">gamma_perterb</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb1</span><span class="p">)</span>

    <span class="c1"># Determine which examples will be augmented</span>
    <span class="n">gammaperterb_flags</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">gamma_perterb</span>

    <span class="c1"># Modify exposure</span>
    <span class="c1"># perlin_min = 0.6</span>
    <span class="c1"># gamma_min = 1.7</span>
    <span class="n">gamma_max</span> <span class="o">=</span> <span class="mf">1.7</span>
    <span class="n">gamma_min</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">gamma_range</span> <span class="o">=</span> <span class="n">gamma_max</span> <span class="o">-</span> <span class="n">gamma_min</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gammaperterb_flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">img1</span> <span class="o">=</span> <span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">gamma1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">gamma_range</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamma_min</span>
        <span class="n">gamma2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">gamma_range</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamma_min</span>
        <span class="c1"># print(&#39;gamma1 = %r&#39; % (gamma1,))</span>
        <span class="c1"># print(&#39;gamma2 = %r&#39; % (gamma2,))</span>
        <span class="n">Xb1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">img1</span> <span class="o">**</span> <span class="p">(</span><span class="n">gamma1</span><span class="p">)</span>
        <span class="n">Xb2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">img2</span> <span class="o">**</span> <span class="p">(</span><span class="n">gamma2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;max/min = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Xb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span></div>


<div class="viewcode-block" id="augment_siamese_patches2"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.augment.augment_siamese_patches2">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">augment_siamese_patches2</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment --test-augment_siamese_patches2 --show --db=PZ_MTEST</span>
<span class="sd">        python -m wbia_cnn.augment --test-augment_siamese_patches2 --show --colorspace=&#39;bgr&#39;</span>

<span class="sd">        # Shows what augumentation looks like durring trainging</span>
<span class="sd">        python -m wbia_cnn.train --test-pz_patchmatch --ds pzmtest --weights=new --arch=siaml2 --train --monitor --DEBUG_AUGMENTATION</span>

<span class="sd">    TODO:</span>
<span class="sd">        zoom in only if a true positive</span>
<span class="sd">        slightly different transforms for each image in the pair</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.augment import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn import ingest_data, utils, draw_results</span>
<span class="sd">        &gt;&gt;&gt; Xb_orig, yb_orig, Xb, yb = testdata_augment()</span>
<span class="sd">        &gt;&gt;&gt; rng = np.random.RandomState(0)</span>
<span class="sd">        &gt;&gt;&gt; Xb, yb = augment_siamese_patches2(Xb, yb, rng=rng)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; show_augmented_patches(Xb_orig, Xb, yb_orig, yb)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">augment_affine</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">data_per_label</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># augment_shadow(Xb, yb, rng)</span>
    <span class="c1"># augment_gamma(Xb, yb, rng)</span>
    <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.augment</span>
<span class="sd">        python -m wbia_cnn.augment --allexamples</span>
<span class="sd">        python -m wbia_cnn.augment --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">wbia-cnn</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../wbia_cnn.html">wbia_cnn package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../wbia_cnn.html">wbia_cnn</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>