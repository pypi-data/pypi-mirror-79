
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia_cnn.experiments &#8212; wbia-cnn 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia_cnn.experiments</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">draw_results</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="sift_dataset_separability"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.experiments.sift_dataset_separability">[docs]</a><span class="k">def</span> <span class="nf">sift_dataset_separability</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    VERY HACKED RIGHT NOW. ONLY LIBERTY. BLINDLY CACHES</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset (?):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.experiments --exec-sift_dataset_separability --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.experiments import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn import ingest_data</span>
<span class="sd">        &gt;&gt;&gt; dataset = ingest_data.grab_liberty_siam_dataset(250000)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; sift_dataset_separability(dataset)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">cached_func</span><span class="p">(</span><span class="s1">&#39;tempsiftscorecache&#39;</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cached_siftscores</span><span class="p">():</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">sift_scores</span><span class="p">,</span> <span class="n">sift_list</span> <span class="o">=</span> <span class="n">test_sift_patchmatch_scores</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">sift_scores</span> <span class="o">=</span> <span class="n">sift_scores</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sift_scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sift_list</span>

    <span class="n">sift_scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sift_list</span> <span class="o">=</span> <span class="n">cached_siftscores</span><span class="p">()</span>

    <span class="c1"># I dont think we can compare lnbnn on liberty</span>
    <span class="c1"># because we dont have a set of id labels, we have</span>
    <span class="c1"># pairs of correspondences.</span>
    <span class="c1"># import pyflann</span>
    <span class="c1"># flann = pyflann.FLANN()</span>
    <span class="c1"># flann.build_index(sift_list)</span>
    <span class="c1"># idxs, dists = flann.nn_index(sift_list, 10)</span>

    <span class="n">encoder_kw</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">#&#39;monotonize&#39;: False,</span>
        <span class="s1">&#39;monotonize&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">sift_encoder</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ScoreNormalizer</span><span class="p">(</span><span class="o">**</span><span class="n">encoder_kw</span><span class="p">)</span>
    <span class="n">sift_encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sift_scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="n">dataname</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">alias_key</span>
    <span class="n">viz_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">with_scores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">with_postbayes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">with_prebayes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">target_tpr</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="n">score_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">inter_sift</span> <span class="o">=</span> <span class="n">sift_encoder</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span>
        <span class="n">figtitle</span><span class="o">=</span><span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; SIFT scores. #data=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">viz_kw</span>
    <span class="p">)</span>

    <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

    <span class="c1"># icon = ibs.get_database_icon()</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;http://www.councilchronicle.com/wp-content/uploads/2015/08/&#39;</span>
        <span class="s1">&#39;West-Virginia-Arrested-over-Bogus-Statue-of-Liberty-Bomb-Threat.jpg&#39;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">icon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">overlay_icon</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">bbox_alignment</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">max_dsize</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">192</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--contextadjust&#39;</span><span class="p">):</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">use_argv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inter_sift</span></div>


<span class="c1"># def extract_sifts(data, labels):</span>
<span class="c1">#    import pyhesaff</span>
<span class="c1">#    if len(data.shape) == 4 and data.shape[-1] == 1:</span>
<span class="c1">#        data = data.reshape(data.shape[0:3])</span>
<span class="c1">#    elif len(data.shape) == 4 and data.shape[-1] == 3:</span>
<span class="c1">#        import vtool as vt</span>
<span class="c1">#        # TODO use dataset to infer data colorspace</span>
<span class="c1">#        data = vt.convert_image_list_colorspace(data, &#39;GRAY&#39;, src_colorspace=&#39;BGR&#39;)</span>
<span class="c1">#    patch_list = data</span>
<span class="c1">#    print(&#39;Extract SIFT descr&#39;)</span>
<span class="c1">#    vecs_list = pyhesaff.extract_desc_from_patches(patch_list)</span>
<span class="c1">#    return vecs_list</span>


<div class="viewcode-block" id="test_sift_patchmatch_scores"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.experiments.test_sift_patchmatch_scores">[docs]</a><span class="k">def</span> <span class="nf">test_sift_patchmatch_scores</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    data = X_test</span>
<span class="sd">    labels = y_test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pyhesaff</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="c1"># TODO use dataset to infer data colorspace</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_image_list_colorspace</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;GRAY&#39;</span><span class="p">,</span> <span class="n">src_colorspace</span><span class="o">=</span><span class="s1">&#39;BGR&#39;</span><span class="p">)</span>
    <span class="n">patch_list</span> <span class="o">=</span> <span class="n">data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extract SIFT descr&#39;</span><span class="p">)</span>
    <span class="n">vecs_list</span> <span class="o">=</span> <span class="n">pyhesaff</span><span class="o">.</span><span class="n">extract_desc_from_patches</span><span class="p">(</span><span class="n">patch_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compute SIFT dist&#39;</span><span class="p">)</span>
    <span class="n">sqrddist</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">vecs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="n">vecs_list</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sqrddist_</span> <span class="o">=</span> <span class="n">sqrddist</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">VEC_PSEUDO_MAX_DISTANCE_SQRD</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">512.0</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="c1"># sift_scores = 1 - (sqrddist_.flatten() / VEC_PSEUDO_MAX_DISTANCE_SQRD)</span>
    <span class="n">sift_scores</span> <span class="o">=</span> <span class="n">sqrddist_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">/</span> <span class="n">VEC_PSEUDO_MAX_DISTANCE_SQRD</span>
    <span class="n">sift_list</span> <span class="o">=</span> <span class="n">vecs_list</span>
    <span class="k">return</span> <span class="n">sift_scores</span><span class="p">,</span> <span class="n">sift_list</span></div>
    <span class="c1"># test_siamese_thresholds(sqrddist_, labels, figtitle=&#39;SIFT descriptor distances&#39;)</span>


<div class="viewcode-block" id="test_siamese_performance"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.experiments.test_siamese_performance">[docs]</a><span class="k">def</span> <span class="nf">test_siamese_performance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flat_metadata</span><span class="p">,</span> <span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        utprof.py -m wbia_cnn --tf pz_patchmatch --db liberty --test --weights=liberty:current --arch=siaml2_128 --test</span>
<span class="sd">        python -m wbia_cnn --tf netrun --db liberty --arch=siaml2_128 --test  --ensure</span>
<span class="sd">        python -m wbia_cnn --tf netrun --db liberty --arch=siaml2_128 --test  --ensure --weights=new</span>
<span class="sd">        python -m wbia_cnn --tf netrun --db liberty --arch=siaml2_128 --train --weights=new</span>
<span class="sd">        python -m wbia_cnn --tf netrun --db pzmtest --weights=liberty:current --arch=siaml2_128 --test  # NOQA</span>
<span class="sd">        python -m wbia_cnn --tf netrun --db pzmtest --weights=liberty:current --arch=siaml2_128</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

    <span class="c1"># TODO: save in model.trainind_dpath/diagnostics/figures</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[siam_perf] Testing Siamese Performance&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="c1"># epoch_dpath = model.get_epoch_diagnostic_dpath()</span>
    <span class="n">epoch_dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">vd</span><span class="p">(</span><span class="n">epoch_dpath</span><span class="p">)</span>

    <span class="n">dataname</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">get_history_hashid</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">history_text</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">era_history</span><span class="p">,</span> <span class="n">newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">epoch_dpath</span><span class="p">,</span> <span class="s1">&#39;era_history.txt&#39;</span><span class="p">),</span> <span class="n">history_text</span><span class="p">)</span>

    <span class="c1"># if True:</span>
    <span class="c1">#    import matplotlib as mpl</span>
    <span class="c1">#    mpl.rcParams[&#39;agg.path.chunksize&#39;] = 100000</span>

    <span class="c1"># data   = data[::50]</span>
    <span class="c1"># labels = labels[::50]</span>
    <span class="c1"># from wbia_cnn import utils</span>
    <span class="c1"># data, labels = utils.random_xy_sample(data, labels, 10000, model.data_per_label_input)</span>

    <span class="n">FULL</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--quick&#39;</span><span class="p">)</span>

    <span class="n">fnum_gen</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_fnum_nextgen</span><span class="p">()</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[siam_perf] Show era history&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_era_loss</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum_gen</span><span class="p">())</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">epoch_dpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>

    <span class="c1"># hack</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[siam_perf] Show weights image&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_weights_image</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum_gen</span><span class="p">())</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">epoch_dpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
    <span class="c1"># model.draw_all_conv_layer_weights(fnum=fnum_gen())</span>
    <span class="c1"># model.imwrite_weights(1)</span>
    <span class="c1"># model.imwrite_weights(2)</span>

    <span class="c1"># Compute each type of score</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[siam_perf] Building Scores&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">network_output</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
    <span class="c1"># hack converting network output to distances for non-descriptor networks</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">network_output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">network_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cnn_scores</span> <span class="o">=</span> <span class="n">network_output</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">network_output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cnn_scores</span> <span class="o">=</span> <span class="n">network_output</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">network_output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">network_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_output</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">vecs1</span> <span class="o">=</span> <span class="n">network_output</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">vecs2</span> <span class="o">=</span> <span class="n">network_output</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">cnn_scores</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">L2</span><span class="p">(</span><span class="n">vecs1</span><span class="p">,</span> <span class="n">vecs2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>
    <span class="n">cnn_scores</span> <span class="o">=</span> <span class="n">cnn_scores</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># Segfaults with the data passed in is large (AND MEMMAPPED apparently)</span>
    <span class="c1"># Fixed in hesaff implementation</span>
    <span class="n">SIFT</span> <span class="o">=</span> <span class="n">FULL</span>
    <span class="k">if</span> <span class="n">SIFT</span><span class="p">:</span>
        <span class="n">sift_scores</span><span class="p">,</span> <span class="n">sift_list</span> <span class="o">=</span> <span class="n">test_sift_patchmatch_scores</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">sift_scores</span> <span class="o">=</span> <span class="n">sift_scores</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[siam_perf] Learning Encoders&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="c1"># Learn encoders</span>
    <span class="n">encoder_kw</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">#&#39;monotonize&#39;: False,</span>
        <span class="s1">&#39;monotonize&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cnn_encoder</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ScoreNormalizer</span><span class="p">(</span><span class="o">**</span><span class="n">encoder_kw</span><span class="p">)</span>
    <span class="n">cnn_encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cnn_scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">SIFT</span><span class="p">:</span>
        <span class="n">sift_encoder</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ScoreNormalizer</span><span class="p">(</span><span class="o">**</span><span class="n">encoder_kw</span><span class="p">)</span>
        <span class="n">sift_encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sift_scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="c1"># Visualize</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[siam_perf] Visualize Encoders&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">viz_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">with_scores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">with_postbayes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">with_prebayes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">target_tpr</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">inter_cnn</span> <span class="o">=</span> <span class="n">cnn_encoder</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span>
        <span class="n">figtitle</span><span class="o">=</span><span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; CNN scores. #data=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
        <span class="n">fnum</span><span class="o">=</span><span class="n">fnum_gen</span><span class="p">(),</span>
        <span class="o">**</span><span class="n">viz_kw</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">SIFT</span><span class="p">:</span>
        <span class="n">inter_sift</span> <span class="o">=</span> <span class="n">sift_encoder</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span>
            <span class="n">figtitle</span><span class="o">=</span><span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; SIFT scores. #data=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="n">fnum</span><span class="o">=</span><span class="n">fnum_gen</span><span class="p">(),</span>
            <span class="o">**</span><span class="n">viz_kw</span>
        <span class="p">)</span>

    <span class="c1"># Save</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">inter_cnn</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">epoch_dpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">SIFT</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">inter_sift</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">epoch_dpath</span><span class="p">)</span>

    <span class="c1"># Save out examples of hard errors</span>
    <span class="c1"># cnn_fp_label_indicies, cnn_fn_label_indicies =</span>
    <span class="c1"># cnn_encoder.get_error_indicies(cnn_scores, labels)</span>
    <span class="c1"># sift_fp_label_indicies, sift_fn_label_indicies =</span>
    <span class="c1"># sift_encoder.get_error_indicies(sift_scores, labels)</span>

    <span class="n">with_patch_examples</span> <span class="o">=</span> <span class="n">FULL</span>
    <span class="k">if</span> <span class="n">with_patch_examples</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[siam_perf] Visualize Confusion Examples&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">cnn_indicies</span> <span class="o">=</span> <span class="n">cnn_encoder</span><span class="o">.</span><span class="n">get_confusion_indicies</span><span class="p">(</span><span class="n">cnn_scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SIFT</span><span class="p">:</span>
            <span class="n">sift_indicies</span> <span class="o">=</span> <span class="n">sift_encoder</span><span class="o">.</span><span class="n">get_confusion_indicies</span><span class="p">(</span><span class="n">sift_scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="n">warped_patch1_list</span><span class="p">,</span> <span class="n">warped_patch2_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ut</span><span class="o">.</span><span class="n">ichunks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">samp_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">warped_patch1_list</span><span class="p">,</span> <span class="n">warped_patch2_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">draw_results</span><span class="o">.</span><span class="n">get_patch_sample_img</span><span class="p">,</span> <span class="o">*</span><span class="n">samp_args</span><span class="p">)</span>

        <span class="n">cnn_fp_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">cnn_scores</span><span class="p">},</span> <span class="n">cnn_indicies</span><span class="o">.</span><span class="n">fp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cnn_fn_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">cnn_scores</span><span class="p">},</span> <span class="n">cnn_indicies</span><span class="o">.</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cnn_tp_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">cnn_scores</span><span class="p">},</span> <span class="n">cnn_indicies</span><span class="o">.</span><span class="n">tp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cnn_tn_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">cnn_scores</span><span class="p">},</span> <span class="n">cnn_indicies</span><span class="o">.</span><span class="n">tn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">SIFT</span><span class="p">:</span>
            <span class="n">sift_fp_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">sift_scores</span><span class="p">},</span> <span class="n">sift_indicies</span><span class="o">.</span><span class="n">fp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sift_fn_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">sift_scores</span><span class="p">},</span> <span class="n">sift_indicies</span><span class="o">.</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sift_tp_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">sift_scores</span><span class="p">},</span> <span class="n">sift_indicies</span><span class="o">.</span><span class="n">tp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sift_tn_img</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">({</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">sift_scores</span><span class="p">},</span> <span class="n">sift_indicies</span><span class="o">.</span><span class="n">tn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if ut.show_was_requested():</span>
        <span class="c1"># def rectify(arr):</span>
        <span class="c1">#    return np.flipud(arr)</span>
        <span class="n">SINGLE_FIG</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">SINGLE_FIG</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">dump_img</span><span class="p">(</span><span class="n">img_</span><span class="p">,</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">fnum</span><span class="p">):</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_</span><span class="p">,</span> <span class="n">figtitle</span><span class="o">=</span><span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">epoch_dpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>

            <span class="n">dump_img</span><span class="p">(</span><span class="n">cnn_fp_img</span><span class="p">,</span> <span class="s1">&#39;cnn_fp_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>
            <span class="n">dump_img</span><span class="p">(</span><span class="n">cnn_fn_img</span><span class="p">,</span> <span class="s1">&#39;cnn_fn_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>
            <span class="n">dump_img</span><span class="p">(</span><span class="n">cnn_tp_img</span><span class="p">,</span> <span class="s1">&#39;cnn_tp_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>
            <span class="n">dump_img</span><span class="p">(</span><span class="n">cnn_tn_img</span><span class="p">,</span> <span class="s1">&#39;cnn_tn_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>

            <span class="n">dump_img</span><span class="p">(</span><span class="n">sift_fp_img</span><span class="p">,</span> <span class="s1">&#39;sift_fp_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>
            <span class="n">dump_img</span><span class="p">(</span><span class="n">sift_fn_img</span><span class="p">,</span> <span class="s1">&#39;sift_fn_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>
            <span class="n">dump_img</span><span class="p">(</span><span class="n">sift_tp_img</span><span class="p">,</span> <span class="s1">&#39;sift_tp_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>
            <span class="n">dump_img</span><span class="p">(</span><span class="n">sift_tn_img</span><span class="p">,</span> <span class="s1">&#39;sift_tn_img&#39;</span><span class="p">,</span> <span class="n">fnum_gen</span><span class="p">())</span>
            <span class="c1"># vt.imwrite(dataname + &#39;_&#39; + &#39;cnn_fp_img.png&#39;, (cnn_fp_img))</span>
            <span class="c1"># vt.imwrite(dataname + &#39;_&#39; + &#39;cnn_fn_img.png&#39;, (cnn_fn_img))</span>
            <span class="c1"># vt.imwrite(dataname + &#39;_&#39; + &#39;sift_fp_img.png&#39;, (sift_fp_img))</span>
            <span class="c1"># vt.imwrite(dataname + &#39;_&#39; + &#39;sift_fn_img.png&#39;, (sift_fn_img))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Drawing TP FP TN FN&#39;</span><span class="p">)</span>
            <span class="n">fnum</span> <span class="o">=</span> <span class="n">fnum_gen</span><span class="p">()</span>
            <span class="n">pnum_gen</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cnn_fp_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CNN FP&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sift_fp_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SIFT FP&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cnn_fn_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CNN FN&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sift_fn_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SIFT FN&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cnn_tp_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CNN TP&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sift_tp_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SIFT TP&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cnn_tn_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CNN TN&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sift_tn_img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SIFT TN&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; confusions&#39;</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">epoch_dpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>

    <span class="n">with_patch_desc</span> <span class="o">=</span> <span class="n">FULL</span>
    <span class="k">if</span> <span class="n">with_patch_desc</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[siam_perf] Visualize Patch Descriptors&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">fnum_gen</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">pnum_gen</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># Compare actual output descriptors</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sift_list</span><span class="p">),</span> <span class="n">num_rows</span><span class="p">):</span>
            <span class="n">vec_sift</span> <span class="o">=</span> <span class="n">sift_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">vec_cnn</span> <span class="o">=</span> <span class="n">network_output</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot_descriptor_signature</span><span class="p">(</span><span class="n">vec_cnn</span><span class="p">,</span> <span class="s1">&#39;cnn vec&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot_sift_signature</span><span class="p">(</span><span class="n">vec_sift</span><span class="p">,</span> <span class="s1">&#39;sift vec&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_gen</span><span class="p">())</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="s1">&#39;Patch Descriptors&#39;</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">epoch_dpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span></div>
        <span class="c1"># ut.vd(epoch_dpath)</span>


<div class="viewcode-block" id="show_hard_cases"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.experiments.show_hard_cases">[docs]</a><span class="k">def</span> <span class="nf">show_hard_cases</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">utils</span>

    <span class="n">encoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">learn_encoder</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>

    <span class="c1"># x = encoder.inverse_normalize(np.cast[&#39;float32&#39;](encoder.learned_thresh))</span>
    <span class="c1"># encoder.normalize_scores(x)</span>
    <span class="c1"># encoder.inverse_normalize(np.cast[&#39;float32&#39;](encoder.learned_thresh))</span>

    <span class="n">fp_label_indicies</span><span class="p">,</span> <span class="n">fn_label_indicies</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">get_error_indicies</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="n">fn_data_indicies</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">expand_data_indicies</span><span class="p">(</span>
        <span class="n">fn_label_indicies</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
    <span class="p">)</span>
    <span class="n">fp_data_indicies</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">expand_data_indicies</span><span class="p">(</span>
        <span class="n">fp_label_indicies</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
    <span class="p">)</span>

    <span class="n">fn_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_data_indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fn_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_label_indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fn_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_label_indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">fp_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fp_data_indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fp_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fp_label_indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fp_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fp_label_indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">draw_results</span>

    <span class="n">draw_results</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>
    <span class="n">draw_results</span><span class="o">.</span><span class="n">interact_siamsese_data_patches</span><span class="p">(</span>
        <span class="n">fn_labels</span><span class="p">,</span> <span class="n">fn_data</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">fn_scores</span><span class="p">},</span> <span class="n">figtitle</span><span class="o">=</span><span class="s1">&#39;FN&#39;</span>
    <span class="p">)</span>
    <span class="n">draw_results</span><span class="o">.</span><span class="n">interact_siamsese_data_patches</span><span class="p">(</span>
        <span class="n">fp_labels</span><span class="p">,</span> <span class="n">fp_data</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">fp_scores</span><span class="p">},</span> <span class="n">figtitle</span><span class="o">=</span><span class="s1">&#39;FP&#39;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="test_siamese_thresholds"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.experiments.test_siamese_thresholds">[docs]</a><span class="k">def</span> <span class="nf">test_siamese_thresholds</span><span class="p">(</span><span class="n">network_output</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test function to see how good of a threshold we can learn</span>

<span class="sd">    network_output = prob_list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="c1"># batch cycling may cause more outputs than test labels.</span>
    <span class="c1"># should be able to just crop</span>
    <span class="n">network_output_</span> <span class="o">=</span> <span class="n">network_output</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">tp_support</span> <span class="o">=</span> <span class="n">network_output_</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">y_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">tn_support</span> <span class="o">=</span> <span class="n">network_output_</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">))]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tp_support</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tn_support</span><span class="o">.</span><span class="n">mean</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need to invert scores&#39;</span><span class="p">)</span>
        <span class="n">tp_support</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">tn_support</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tn_support</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">tp_support</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">bottom</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need to subtract from scores&#39;</span><span class="p">)</span>
        <span class="n">tn_support</span> <span class="o">-=</span> <span class="n">bottom</span>
        <span class="n">tp_support</span> <span class="o">-=</span> <span class="n">bottom</span>

    <span class="n">vt</span><span class="o">.</span><span class="n">score_normalization</span><span class="o">.</span><span class="n">rrr</span><span class="p">()</span>
    <span class="n">vt</span><span class="o">.</span><span class="n">score_normalization</span><span class="o">.</span><span class="n">test_score_normalization</span><span class="p">(</span>
        <span class="n">tp_support</span><span class="p">,</span> <span class="n">tn_support</span><span class="p">,</span> <span class="n">with_scores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>

    <span class="c1"># from wbia.algo.hots import score_normalization</span>
    <span class="c1"># test_score_normalization</span>
    <span class="c1"># learnkw = dict()</span>
    <span class="c1"># learntup = score_normalization.learn_score_normalization(</span>
    <span class="c1">#    tp_support, tn_support, return_all=False, **learnkw)</span>
    <span class="c1"># (score_domain, p_tp_given_score, clip_score) = learntup</span>
    <span class="c1"># Plotting</span>
    <span class="c1"># import plottool as pt</span>
    <span class="c1"># fnum = 1</span>
    <span class="c1"># pt.figure(fnum=fnum, pnum=(2, 1, 1), doclf=True, docla=True)</span>
    <span class="c1"># score_normalization.plot_support(tn_support, tp_support, fnum=fnum, pnum=(2, 1, 1))</span>
    <span class="c1"># score_normalization.plot_postbayes_pdf(</span>
    <span class="c1">#    score_domain, 1 - p_tp_given_score, p_tp_given_score, fnum=fnum, pnum=(2, 1, 2))</span>
    <span class="c1"># pass</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.experiments</span>
<span class="sd">        python -m wbia_cnn.experiments --allexamples</span>
<span class="sd">        python -m wbia_cnn.experiments --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">wbia-cnn</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../wbia_cnn.html">wbia_cnn package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../wbia_cnn.html">wbia_cnn</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>